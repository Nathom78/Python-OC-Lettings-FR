
<!DOCTYPE html>


<html lang="fr" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>django.db.models.fields.related_descriptors &#8212; Documentation Orange County Lettings </title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=362ab14a" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/perso.css?v=9f767776" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script src="../../../../../_static/documentation_options.js?v=0ef26a9d"></script>
    <script src="../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../../../_static/translations.js?v=d99ca74e"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/django/db/models/fields/related_descriptors';</script>
    <link rel="icon" href="../../../../../_static/logo.png"/>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="fr"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Passer au contenu principal</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../../../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../../../../../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../../../../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
    
  </div>
  
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Navigation du site">
    Navigation du site
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../README.html">
                        Démarrage rapide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../configuration_and_security.html">
                        Configuration et sécurité
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../deployment_and_tests.html">
                        Déploiement et tests
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../database.html">
                        Base de donnée
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../usage.html">
                        Usage
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../modules.html">
                        Code
                      </a>
                    </li>
                
                </div>
            </div>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Recherche" aria-label="Recherche" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="clair/sombre" aria-label="clair/sombre" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Nathom78/Python-OC-Lettings-FR" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://orange-county-lettings.azurewebsites.net/" title="Azure site" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../../../../_static/Microsoft-Azure.png" class="icon-link-image" alt="Azure site"/></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Recherche" aria-label="Recherche" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Navigation du site">
    Navigation du site
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../README.html">
                        Démarrage rapide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../configuration_and_security.html">
                        Configuration et sécurité
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../deployment_and_tests.html">
                        Déploiement et tests
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../database.html">
                        Base de donnée
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../usage.html">
                        Usage
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../../../modules.html">
                        Code
                      </a>
                    </li>
                
                </div>
            </div>
            
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="clair/sombre" aria-label="clair/sombre" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Nathom78/Python-OC-Lettings-FR" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://orange-county-lettings.azurewebsites.net/" title="Azure site" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../../../../_static/Microsoft-Azure.png" class="icon-link-image" alt="Azure site"/></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Fils d'Ariane">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Fil d'Ariane">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../../index.html" class="nav-link" aria-label="Acceuil">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../../index.html" class="nav-link">Code du module</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">django.db.models.fields.related_descriptors</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Code source de django.db.models.fields.related_descriptors</h1><div class="highlight"><pre>
<span></span><span class="linenos">   1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">   2</span><span class="sd">Accessors for related objects.</span>
<span class="linenos">   3</span>
<span class="linenos">   4</span><span class="sd">When a field defines a relation between two models, each model class provides</span>
<span class="linenos">   5</span><span class="sd">an attribute to access related instances of the other model class (unless the</span>
<span class="linenos">   6</span><span class="sd">reverse accessor has been disabled with related_name=&#39;+&#39;).</span>
<span class="linenos">   7</span>
<span class="linenos">   8</span><span class="sd">Accessors are implemented as descriptors in order to customize access and</span>
<span class="linenos">   9</span><span class="sd">assignment. This module defines the descriptor classes.</span>
<span class="linenos">  10</span>
<span class="linenos">  11</span><span class="sd">Forward accessors follow foreign keys. Reverse accessors trace them back. For</span>
<span class="linenos">  12</span><span class="sd">example, with the following models::</span>
<span class="linenos">  13</span>
<span class="linenos">  14</span><span class="sd">    class Parent(Model):</span>
<span class="linenos">  15</span><span class="sd">        pass</span>
<span class="linenos">  16</span>
<span class="linenos">  17</span><span class="sd">    class Child(Model):</span>
<span class="linenos">  18</span><span class="sd">        parent = ForeignKey(Parent, related_name=&#39;children&#39;)</span>
<span class="linenos">  19</span>
<span class="linenos">  20</span><span class="sd"> ``child.parent`` is a forward many-to-one relation. ``parent.children`` is a</span>
<span class="linenos">  21</span><span class="sd">reverse many-to-one relation.</span>
<span class="linenos">  22</span>
<span class="linenos">  23</span><span class="sd">There are three types of relations (many-to-one, one-to-one, and many-to-many)</span>
<span class="linenos">  24</span><span class="sd">and two directions (forward and reverse) for a total of six combinations.</span>
<span class="linenos">  25</span>
<span class="linenos">  26</span><span class="sd">1. Related instance on the forward side of a many-to-one relation:</span>
<span class="linenos">  27</span><span class="sd">   ``ForwardManyToOneDescriptor``.</span>
<span class="linenos">  28</span>
<span class="linenos">  29</span><span class="sd">   Uniqueness of foreign key values is irrelevant to accessing the related</span>
<span class="linenos">  30</span><span class="sd">   instance, making the many-to-one and one-to-one cases identical as far as</span>
<span class="linenos">  31</span><span class="sd">   the descriptor is concerned. The constraint is checked upstream (unicity</span>
<span class="linenos">  32</span><span class="sd">   validation in forms) or downstream (unique indexes in the database).</span>
<span class="linenos">  33</span>
<span class="linenos">  34</span><span class="sd">2. Related instance on the forward side of a one-to-one</span>
<span class="linenos">  35</span><span class="sd">   relation: ``ForwardOneToOneDescriptor``.</span>
<span class="linenos">  36</span>
<span class="linenos">  37</span><span class="sd">   It avoids querying the database when accessing the parent link field in</span>
<span class="linenos">  38</span><span class="sd">   a multi-table inheritance scenario.</span>
<span class="linenos">  39</span>
<span class="linenos">  40</span><span class="sd">3. Related instance on the reverse side of a one-to-one relation:</span>
<span class="linenos">  41</span><span class="sd">   ``ReverseOneToOneDescriptor``.</span>
<span class="linenos">  42</span>
<span class="linenos">  43</span><span class="sd">   One-to-one relations are asymmetrical, despite the apparent symmetry of the</span>
<span class="linenos">  44</span><span class="sd">   name, because they&#39;re implemented in the database with a foreign key from</span>
<span class="linenos">  45</span><span class="sd">   one table to another. As a consequence ``ReverseOneToOneDescriptor`` is</span>
<span class="linenos">  46</span><span class="sd">   slightly different from ``ForwardManyToOneDescriptor``.</span>
<span class="linenos">  47</span>
<span class="linenos">  48</span><span class="sd">4. Related objects manager for related instances on the reverse side of a</span>
<span class="linenos">  49</span><span class="sd">   many-to-one relation: ``ReverseManyToOneDescriptor``.</span>
<span class="linenos">  50</span>
<span class="linenos">  51</span><span class="sd">   Unlike the previous two classes, this one provides access to a collection</span>
<span class="linenos">  52</span><span class="sd">   of objects. It returns a manager rather than an instance.</span>
<span class="linenos">  53</span>
<span class="linenos">  54</span><span class="sd">5. Related objects manager for related instances on the forward or reverse</span>
<span class="linenos">  55</span><span class="sd">   sides of a many-to-many relation: ``ManyToManyDescriptor``.</span>
<span class="linenos">  56</span>
<span class="linenos">  57</span><span class="sd">   Many-to-many relations are symmetrical. The syntax of Django models</span>
<span class="linenos">  58</span><span class="sd">   requires declaring them on one side but that&#39;s an implementation detail.</span>
<span class="linenos">  59</span><span class="sd">   They could be declared on the other side without any change in behavior.</span>
<span class="linenos">  60</span><span class="sd">   Therefore the forward and reverse descriptors can be the same.</span>
<span class="linenos">  61</span>
<span class="linenos">  62</span><span class="sd">   If you&#39;re looking for ``ForwardManyToManyDescriptor`` or</span>
<span class="linenos">  63</span><span class="sd">   ``ReverseManyToManyDescriptor``, use ``ManyToManyDescriptor`` instead.</span>
<span class="linenos">  64</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  65</span>
<span class="linenos">  66</span><span class="kn">from</span> <span class="nn">asgiref.sync</span> <span class="kn">import</span> <span class="n">sync_to_async</span>
<span class="linenos">  67</span>
<span class="linenos">  68</span><span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">FieldError</span>
<span class="linenos">  69</span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="p">(</span>
<span class="linenos">  70</span>    <span class="n">DEFAULT_DB_ALIAS</span><span class="p">,</span>
<span class="linenos">  71</span>    <span class="n">NotSupportedError</span><span class="p">,</span>
<span class="linenos">  72</span>    <span class="n">connections</span><span class="p">,</span>
<span class="linenos">  73</span>    <span class="n">router</span><span class="p">,</span>
<span class="linenos">  74</span>    <span class="n">transaction</span><span class="p">,</span>
<span class="linenos">  75</span><span class="p">)</span>
<span class="linenos">  76</span><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Q</span><span class="p">,</span> <span class="n">Window</span><span class="p">,</span> <span class="n">signals</span>
<span class="linenos">  77</span><span class="kn">from</span> <span class="nn">django.db.models.functions</span> <span class="kn">import</span> <span class="n">RowNumber</span>
<span class="linenos">  78</span><span class="kn">from</span> <span class="nn">django.db.models.lookups</span> <span class="kn">import</span> <span class="n">GreaterThan</span><span class="p">,</span> <span class="n">LessThanOrEqual</span>
<span class="linenos">  79</span><span class="kn">from</span> <span class="nn">django.db.models.query</span> <span class="kn">import</span> <span class="n">QuerySet</span>
<span class="linenos">  80</span><span class="kn">from</span> <span class="nn">django.db.models.query_utils</span> <span class="kn">import</span> <span class="n">DeferredAttribute</span>
<span class="linenos">  81</span><span class="kn">from</span> <span class="nn">django.db.models.utils</span> <span class="kn">import</span> <span class="n">AltersData</span><span class="p">,</span> <span class="n">resolve_callables</span>
<span class="linenos">  82</span><span class="kn">from</span> <span class="nn">django.utils.functional</span> <span class="kn">import</span> <span class="n">cached_property</span>
<span class="linenos">  83</span>
<span class="linenos">  84</span>
<span class="linenos">  85</span><span class="k">class</span> <span class="nc">ForeignKeyDeferredAttribute</span><span class="p">(</span><span class="n">DeferredAttribute</span><span class="p">):</span>
<span class="linenos">  86</span>    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos">  87</span>        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span> <span class="o">!=</span> <span class="n">value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">is_cached</span><span class="p">(</span>
<span class="linenos">  88</span>            <span class="n">instance</span>
<span class="linenos">  89</span>        <span class="p">):</span>
<span class="linenos">  90</span>            <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">delete_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos">  91</span>        <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="linenos">  92</span>
<span class="linenos">  93</span>
<span class="linenos">  94</span><span class="k">def</span> <span class="nf">_filter_prefetch_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">instances</span><span class="p">):</span>
<span class="linenos">  95</span>    <span class="n">predicate</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">__in&quot;</span><span class="p">:</span> <span class="n">instances</span><span class="p">})</span>
<span class="linenos">  96</span>    <span class="n">db</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">_db</span> <span class="ow">or</span> <span class="n">DEFAULT_DB_ALIAS</span>
<span class="linenos">  97</span>    <span class="k">if</span> <span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">is_sliced</span><span class="p">:</span>
<span class="linenos">  98</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">connections</span><span class="p">[</span><span class="n">db</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">supports_over_clause</span><span class="p">:</span>
<span class="linenos">  99</span>            <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span>
<span class="linenos"> 100</span>                <span class="s2">&quot;Prefetching from a limited queryset is only supported on backends &quot;</span>
<span class="linenos"> 101</span>                <span class="s2">&quot;that support window functions.&quot;</span>
<span class="linenos"> 102</span>            <span class="p">)</span>
<span class="linenos"> 103</span>        <span class="n">low_mark</span><span class="p">,</span> <span class="n">high_mark</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">low_mark</span><span class="p">,</span> <span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">high_mark</span>
<span class="linenos"> 104</span>        <span class="n">order_by</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 105</span>            <span class="n">expr</span> <span class="k">for</span> <span class="n">expr</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">get_order_by</span><span class="p">()</span>
<span class="linenos"> 106</span>        <span class="p">]</span>
<span class="linenos"> 107</span>        <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">RowNumber</span><span class="p">(),</span> <span class="n">partition_by</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="n">order_by</span><span class="p">)</span>
<span class="linenos"> 108</span>        <span class="n">predicate</span> <span class="o">&amp;=</span> <span class="n">GreaterThan</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">low_mark</span><span class="p">)</span>
<span class="linenos"> 109</span>        <span class="k">if</span> <span class="n">high_mark</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 110</span>            <span class="n">predicate</span> <span class="o">&amp;=</span> <span class="n">LessThanOrEqual</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">high_mark</span><span class="p">)</span>
<span class="linenos"> 111</span>        <span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">clear_limits</span><span class="p">()</span>
<span class="linenos"> 112</span>    <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">predicate</span><span class="p">)</span>
<span class="linenos"> 113</span>
<span class="linenos"> 114</span>
<span class="linenos"> 115</span><span class="k">class</span> <span class="nc">ForwardManyToOneDescriptor</span><span class="p">:</span>
<span class="linenos"> 116</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 117</span><span class="sd">    Accessor to the related object on the forward side of a many-to-one or</span>
<span class="linenos"> 118</span><span class="sd">    one-to-one (via ForwardOneToOneDescriptor subclass) relation.</span>
<span class="linenos"> 119</span>
<span class="linenos"> 120</span><span class="sd">    In the example::</span>
<span class="linenos"> 121</span>
<span class="linenos"> 122</span><span class="sd">        class Child(Model):</span>
<span class="linenos"> 123</span><span class="sd">            parent = ForeignKey(Parent, related_name=&#39;children&#39;)</span>
<span class="linenos"> 124</span>
<span class="linenos"> 125</span><span class="sd">    ``Child.parent`` is a ``ForwardManyToOneDescriptor`` instance.</span>
<span class="linenos"> 126</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 127</span>
<span class="linenos"> 128</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_with_rel</span><span class="p">):</span>
<span class="linenos"> 129</span>        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field_with_rel</span>
<span class="linenos"> 130</span>
<span class="linenos"> 131</span>    <span class="nd">@cached_property</span>
<span class="linenos"> 132</span>    <span class="k">def</span> <span class="nf">RelatedObjectDoesNotExist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 133</span>        <span class="c1"># The exception can&#39;t be created at initialization time since the</span>
<span class="linenos"> 134</span>        <span class="c1"># related model might not be resolved yet; `self.field.model` might</span>
<span class="linenos"> 135</span>        <span class="c1"># still be a string model reference.</span>
<span class="linenos"> 136</span>        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span>
<span class="linenos"> 137</span>            <span class="s2">&quot;RelatedObjectDoesNotExist&quot;</span><span class="p">,</span>
<span class="linenos"> 138</span>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">),</span>
<span class="linenos"> 139</span>            <span class="p">{</span>
<span class="linenos"> 140</span>                <span class="s2">&quot;__module__&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
<span class="linenos"> 141</span>                <span class="s2">&quot;__qualname__&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.RelatedObjectDoesNotExist&quot;</span>
<span class="linenos"> 142</span>                <span class="o">%</span> <span class="p">(</span>
<span class="linenos"> 143</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
<span class="linenos"> 144</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="linenos"> 145</span>                <span class="p">),</span>
<span class="linenos"> 146</span>            <span class="p">},</span>
<span class="linenos"> 147</span>        <span class="p">)</span>
<span class="linenos"> 148</span>
<span class="linenos"> 149</span>    <span class="k">def</span> <span class="nf">is_cached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
<span class="linenos"> 150</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">is_cached</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 151</span>
<span class="linenos"> 152</span>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
<span class="linenos"> 153</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_base_manager</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">hints</span><span class="o">=</span><span class="n">hints</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="linenos"> 154</span>
<span class="linenos"> 155</span>    <span class="k">def</span> <span class="nf">get_prefetch_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 156</span>        <span class="k">if</span> <span class="n">queryset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 157</span>            <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
<span class="linenos"> 158</span>        <span class="n">queryset</span><span class="o">.</span><span class="n">_add_hints</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instances</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos"> 159</span>
<span class="linenos"> 160</span>        <span class="n">rel_obj_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_foreign_related_value</span>
<span class="linenos"> 161</span>        <span class="n">instance_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_local_related_value</span>
<span class="linenos"> 162</span>        <span class="n">instances_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">instance_attr</span><span class="p">(</span><span class="n">inst</span><span class="p">):</span> <span class="n">inst</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">}</span>
<span class="linenos"> 163</span>        <span class="n">related_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">foreign_related_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 164</span>        <span class="n">remote_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span>
<span class="linenos"> 165</span>
<span class="linenos"> 166</span>        <span class="c1"># FIXME: This will need to be revisited when we introduce support for</span>
<span class="linenos"> 167</span>        <span class="c1"># composite fields. In the meantime we take this practical approach to</span>
<span class="linenos"> 168</span>        <span class="c1"># solve a regression on 1.6 when the reverse manager in hidden</span>
<span class="linenos"> 169</span>        <span class="c1"># (related_name ends with a &#39;+&#39;). Refs #21410.</span>
<span class="linenos"> 170</span>        <span class="c1"># The check for len(...) == 1 is a special case that allows the query</span>
<span class="linenos"> 171</span>        <span class="c1"># to be join-less and smaller. Refs #21760.</span>
<span class="linenos"> 172</span>        <span class="k">if</span> <span class="n">remote_field</span><span class="o">.</span><span class="n">is_hidden</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">foreign_related_fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos"> 173</span>            <span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 174</span>                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">__in&quot;</span>
<span class="linenos"> 175</span>                <span class="o">%</span> <span class="n">related_field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span><span class="n">instance_attr</span><span class="p">(</span><span class="n">inst</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">}</span>
<span class="linenos"> 176</span>            <span class="p">}</span>
<span class="linenos"> 177</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 178</span>            <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">__in&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">related_query_name</span><span class="p">():</span> <span class="n">instances</span><span class="p">}</span>
<span class="linenos"> 179</span>        <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">query</span><span class="p">)</span>
<span class="linenos"> 180</span>
<span class="linenos"> 181</span>        <span class="c1"># Since we&#39;re going to assign directly in the cache,</span>
<span class="linenos"> 182</span>        <span class="c1"># we must manage the reverse relation cache manually.</span>
<span class="linenos"> 183</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">remote_field</span><span class="o">.</span><span class="n">multiple</span><span class="p">:</span>
<span class="linenos"> 184</span>            <span class="k">for</span> <span class="n">rel_obj</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
<span class="linenos"> 185</span>                <span class="n">instance</span> <span class="o">=</span> <span class="n">instances_dict</span><span class="p">[</span><span class="n">rel_obj_attr</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">)]</span>
<span class="linenos"> 186</span>                <span class="n">remote_field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 187</span>        <span class="k">return</span> <span class="p">(</span>
<span class="linenos"> 188</span>            <span class="n">queryset</span><span class="p">,</span>
<span class="linenos"> 189</span>            <span class="n">rel_obj_attr</span><span class="p">,</span>
<span class="linenos"> 190</span>            <span class="n">instance_attr</span><span class="p">,</span>
<span class="linenos"> 191</span>            <span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 192</span>            <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_cache_name</span><span class="p">(),</span>
<span class="linenos"> 193</span>            <span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 194</span>        <span class="p">)</span>
<span class="linenos"> 195</span>
<span class="linenos"> 196</span>    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
<span class="linenos"> 197</span>        <span class="n">qs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 198</span>        <span class="c1"># Assuming the database enforces foreign keys, this won&#39;t fail.</span>
<span class="linenos"> 199</span>        <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_reverse_related_filter</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
<span class="linenos"> 200</span>
<span class="linenos"> 201</span>    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 202</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 203</span><span class="sd">        Get the related instance through the forward relation.</span>
<span class="linenos"> 204</span>
<span class="linenos"> 205</span><span class="sd">        With the example above, when getting ``child.parent``:</span>
<span class="linenos"> 206</span>
<span class="linenos"> 207</span><span class="sd">        - ``self`` is the descriptor managing the ``parent`` attribute</span>
<span class="linenos"> 208</span><span class="sd">        - ``instance`` is the ``child`` instance</span>
<span class="linenos"> 209</span><span class="sd">        - ``cls`` is the ``Child`` class (we don&#39;t need it)</span>
<span class="linenos"> 210</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 211</span>        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 212</span>            <span class="k">return</span> <span class="bp">self</span>
<span class="linenos"> 213</span>
<span class="linenos"> 214</span>        <span class="c1"># The related instance is loaded from the database and then cached</span>
<span class="linenos"> 215</span>        <span class="c1"># by the field on the model instance state. It can also be pre-cached</span>
<span class="linenos"> 216</span>        <span class="c1"># by the reverse accessor (ReverseOneToOneDescriptor).</span>
<span class="linenos"> 217</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 218</span>            <span class="n">rel_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 219</span>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
<span class="linenos"> 220</span>            <span class="n">has_value</span> <span class="o">=</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_local_related_value</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 221</span>            <span class="n">ancestor_link</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos"> 222</span>                <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_ancestor_link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
<span class="linenos"> 223</span>                <span class="k">if</span> <span class="n">has_value</span>
<span class="linenos"> 224</span>                <span class="k">else</span> <span class="kc">None</span>
<span class="linenos"> 225</span>            <span class="p">)</span>
<span class="linenos"> 226</span>            <span class="k">if</span> <span class="n">ancestor_link</span> <span class="ow">and</span> <span class="n">ancestor_link</span><span class="o">.</span><span class="n">is_cached</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
<span class="linenos"> 227</span>                <span class="c1"># An ancestor link will exist if this field is defined on a</span>
<span class="linenos"> 228</span>                <span class="c1"># multi-table inheritance parent of the instance&#39;s class.</span>
<span class="linenos"> 229</span>                <span class="n">ancestor</span> <span class="o">=</span> <span class="n">ancestor_link</span><span class="o">.</span><span class="n">get_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 230</span>                <span class="c1"># The value might be cached on an ancestor if the instance</span>
<span class="linenos"> 231</span>                <span class="c1"># originated from walking down the inheritance chain.</span>
<span class="linenos"> 232</span>                <span class="n">rel_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_cached_value</span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 233</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 234</span>                <span class="n">rel_obj</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 235</span>            <span class="k">if</span> <span class="n">rel_obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">has_value</span><span class="p">:</span>
<span class="linenos"> 236</span>                <span class="n">rel_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 237</span>                <span class="n">remote_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span>
<span class="linenos"> 238</span>                <span class="c1"># If this is a one-to-one relation, set the reverse accessor</span>
<span class="linenos"> 239</span>                <span class="c1"># cache on the related object to the current instance to avoid</span>
<span class="linenos"> 240</span>                <span class="c1"># an extra SQL query if it&#39;s accessed later on.</span>
<span class="linenos"> 241</span>                <span class="k">if</span> <span class="ow">not</span> <span class="n">remote_field</span><span class="o">.</span><span class="n">multiple</span><span class="p">:</span>
<span class="linenos"> 242</span>                    <span class="n">remote_field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 243</span>            <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">rel_obj</span><span class="p">)</span>
<span class="linenos"> 244</span>
<span class="linenos"> 245</span>        <span class="k">if</span> <span class="n">rel_obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">null</span><span class="p">:</span>
<span class="linenos"> 246</span>            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">RelatedObjectDoesNotExist</span><span class="p">(</span>
<span class="linenos"> 247</span>                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has no </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 248</span>            <span class="p">)</span>
<span class="linenos"> 249</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 250</span>            <span class="k">return</span> <span class="n">rel_obj</span>
<span class="linenos"> 251</span>
<span class="linenos"> 252</span>    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos"> 253</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 254</span><span class="sd">        Set the related instance through the forward relation.</span>
<span class="linenos"> 255</span>
<span class="linenos"> 256</span><span class="sd">        With the example above, when setting ``child.parent = parent``:</span>
<span class="linenos"> 257</span>
<span class="linenos"> 258</span><span class="sd">        - ``self`` is the descriptor managing the ``parent`` attribute</span>
<span class="linenos"> 259</span><span class="sd">        - ``instance`` is the ``child`` instance</span>
<span class="linenos"> 260</span><span class="sd">        - ``value`` is the ``parent`` instance on the right of the equal sign</span>
<span class="linenos"> 261</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 262</span>        <span class="c1"># An object must be an instance of the related class.</span>
<span class="linenos"> 263</span>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
<span class="linenos"> 264</span>            <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_model</span>
<span class="linenos"> 265</span>        <span class="p">):</span>
<span class="linenos"> 266</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos"> 267</span>                <span class="s1">&#39;Cannot assign &quot;</span><span class="si">%r</span><span class="s1">&quot;: &quot;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&quot; must be a &quot;</span><span class="si">%s</span><span class="s1">&quot; instance.&#39;</span>
<span class="linenos"> 268</span>                <span class="o">%</span> <span class="p">(</span>
<span class="linenos"> 269</span>                    <span class="n">value</span><span class="p">,</span>
<span class="linenos"> 270</span>                    <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
<span class="linenos"> 271</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="linenos"> 272</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
<span class="linenos"> 273</span>                <span class="p">)</span>
<span class="linenos"> 274</span>            <span class="p">)</span>
<span class="linenos"> 275</span>        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 276</span>            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 277</span>                <span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span>
<span class="linenos"> 278</span>                    <span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">value</span>
<span class="linenos"> 279</span>                <span class="p">)</span>
<span class="linenos"> 280</span>            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 281</span>                <span class="n">value</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span>
<span class="linenos"> 282</span>                    <span class="n">value</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span>
<span class="linenos"> 283</span>                <span class="p">)</span>
<span class="linenos"> 284</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">router</span><span class="o">.</span><span class="n">allow_relation</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
<span class="linenos"> 285</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos"> 286</span>                    <span class="s1">&#39;Cannot assign &quot;</span><span class="si">%r</span><span class="s1">&quot;: the current database router prevents this &#39;</span>
<span class="linenos"> 287</span>                    <span class="s2">&quot;relation.&quot;</span> <span class="o">%</span> <span class="n">value</span>
<span class="linenos"> 288</span>                <span class="p">)</span>
<span class="linenos"> 289</span>
<span class="linenos"> 290</span>        <span class="n">remote_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span>
<span class="linenos"> 291</span>        <span class="c1"># If we&#39;re setting the value of a OneToOneField to None, we need to clear</span>
<span class="linenos"> 292</span>        <span class="c1"># out the cache on any old related object. Otherwise, deleting the</span>
<span class="linenos"> 293</span>        <span class="c1"># previously-related object will also cause this object to be deleted,</span>
<span class="linenos"> 294</span>        <span class="c1"># which is wrong.</span>
<span class="linenos"> 295</span>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 296</span>            <span class="c1"># Look up the previously-related object, which may still be available</span>
<span class="linenos"> 297</span>            <span class="c1"># since we&#39;ve not yet cleared out the related field.</span>
<span class="linenos"> 298</span>            <span class="c1"># Use the cache directly, instead of the accessor; if we haven&#39;t</span>
<span class="linenos"> 299</span>            <span class="c1"># populated the cache, then we don&#39;t care - we&#39;re only accessing</span>
<span class="linenos"> 300</span>            <span class="c1"># the object to invalidate the accessor cache, so there&#39;s no</span>
<span class="linenos"> 301</span>            <span class="c1"># need to populate the cache just to expire it again.</span>
<span class="linenos"> 302</span>            <span class="n">related</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 303</span>
<span class="linenos"> 304</span>            <span class="c1"># If we&#39;ve got an old related object, we need to clear out its</span>
<span class="linenos"> 305</span>            <span class="c1"># cache. This cache also might not exist if the related object</span>
<span class="linenos"> 306</span>            <span class="c1"># hasn&#39;t been accessed yet.</span>
<span class="linenos"> 307</span>            <span class="k">if</span> <span class="n">related</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 308</span>                <span class="n">remote_field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">related</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 309</span>
<span class="linenos"> 310</span>            <span class="k">for</span> <span class="n">lh_field</span><span class="p">,</span> <span class="n">rh_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">related_fields</span><span class="p">:</span>
<span class="linenos"> 311</span>                <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">lh_field</span><span class="o">.</span><span class="n">attname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 312</span>
<span class="linenos"> 313</span>        <span class="c1"># Set the values of the related field.</span>
<span class="linenos"> 314</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 315</span>            <span class="k">for</span> <span class="n">lh_field</span><span class="p">,</span> <span class="n">rh_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">related_fields</span><span class="p">:</span>
<span class="linenos"> 316</span>                <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">lh_field</span><span class="o">.</span><span class="n">attname</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">rh_field</span><span class="o">.</span><span class="n">attname</span><span class="p">))</span>
<span class="linenos"> 317</span>
<span class="linenos"> 318</span>        <span class="c1"># Set the related instance cache used by __get__ to avoid an SQL query</span>
<span class="linenos"> 319</span>        <span class="c1"># when accessing the attribute we just set.</span>
<span class="linenos"> 320</span>        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="linenos"> 321</span>
<span class="linenos"> 322</span>        <span class="c1"># If this is a one-to-one relation, set the reverse accessor cache on</span>
<span class="linenos"> 323</span>        <span class="c1"># the related object to the current instance to avoid an extra SQL</span>
<span class="linenos"> 324</span>        <span class="c1"># query if it&#39;s accessed later on.</span>
<span class="linenos"> 325</span>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">remote_field</span><span class="o">.</span><span class="n">multiple</span><span class="p">:</span>
<span class="linenos"> 326</span>            <span class="n">remote_field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 327</span>
<span class="linenos"> 328</span>    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 329</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 330</span><span class="sd">        Pickling should return the instance attached by self.field on the</span>
<span class="linenos"> 331</span><span class="sd">        model, not a new copy of that descriptor. Use getattr() to retrieve</span>
<span class="linenos"> 332</span><span class="sd">        the instance directly from the model.</span>
<span class="linenos"> 333</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 334</span>        <span class="k">return</span> <span class="nb">getattr</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 335</span>
<span class="linenos"> 336</span>
<span class="linenos"> 337</span><span class="k">class</span> <span class="nc">ForwardOneToOneDescriptor</span><span class="p">(</span><span class="n">ForwardManyToOneDescriptor</span><span class="p">):</span>
<span class="linenos"> 338</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 339</span><span class="sd">    Accessor to the related object on the forward side of a one-to-one relation.</span>
<span class="linenos"> 340</span>
<span class="linenos"> 341</span><span class="sd">    In the example::</span>
<span class="linenos"> 342</span>
<span class="linenos"> 343</span><span class="sd">        class Restaurant(Model):</span>
<span class="linenos"> 344</span><span class="sd">            place = OneToOneField(Place, related_name=&#39;restaurant&#39;)</span>
<span class="linenos"> 345</span>
<span class="linenos"> 346</span><span class="sd">    ``Restaurant.place`` is a ``ForwardOneToOneDescriptor`` instance.</span>
<span class="linenos"> 347</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 348</span>
<span class="linenos"> 349</span>    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
<span class="linenos"> 350</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">parent_link</span><span class="p">:</span>
<span class="linenos"> 351</span>            <span class="n">deferred</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_deferred_fields</span><span class="p">()</span>
<span class="linenos"> 352</span>            <span class="c1"># Because it&#39;s a parent link, all the data is available in the</span>
<span class="linenos"> 353</span>            <span class="c1"># instance, so populate the parent model with this data.</span>
<span class="linenos"> 354</span>            <span class="n">rel_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span>
<span class="linenos"> 355</span>            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">attname</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">rel_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_fields</span><span class="p">]</span>
<span class="linenos"> 356</span>
<span class="linenos"> 357</span>            <span class="c1"># If any of the related model&#39;s fields are deferred, fallback to</span>
<span class="linenos"> 358</span>            <span class="c1"># fetching all fields from the related model. This avoids a query</span>
<span class="linenos"> 359</span>            <span class="c1"># on the related model for every deferred field.</span>
<span class="linenos"> 360</span>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">deferred</span><span class="p">):</span>
<span class="linenos"> 361</span>                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">}</span>
<span class="linenos"> 362</span>                <span class="n">obj</span> <span class="o">=</span> <span class="n">rel_model</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 363</span>                <span class="n">obj</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">adding</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">adding</span>
<span class="linenos"> 364</span>                <span class="n">obj</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span>
<span class="linenos"> 365</span>                <span class="k">return</span> <span class="n">obj</span>
<span class="linenos"> 366</span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 367</span>
<span class="linenos"> 368</span>    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos"> 369</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="linenos"> 370</span>        <span class="c1"># If the primary key is a link to a parent model and a parent instance</span>
<span class="linenos"> 371</span>        <span class="c1"># is being set, update the value of the inherited pk(s).</span>
<span class="linenos"> 372</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">parent_link</span><span class="p">:</span>
<span class="linenos"> 373</span>            <span class="n">opts</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span>
<span class="linenos"> 374</span>            <span class="c1"># Inherited primary key fields from this object&#39;s base classes.</span>
<span class="linenos"> 375</span>            <span class="n">inherited_pk_fields</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos"> 376</span>                <span class="n">field</span>
<span class="linenos"> 377</span>                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">concrete_fields</span>
<span class="linenos"> 378</span>                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span>
<span class="linenos"> 379</span>            <span class="p">]</span>
<span class="linenos"> 380</span>            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">inherited_pk_fields</span><span class="p">:</span>
<span class="linenos"> 381</span>                <span class="n">rel_model_pk_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">attname</span>
<span class="linenos"> 382</span>                <span class="n">raw_value</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos"> 383</span>                    <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">rel_model_pk_name</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<span class="linenos"> 384</span>                <span class="p">)</span>
<span class="linenos"> 385</span>                <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">rel_model_pk_name</span><span class="p">,</span> <span class="n">raw_value</span><span class="p">)</span>
<span class="linenos"> 386</span>
<span class="linenos"> 387</span>
<span class="linenos"> 388</span><span class="k">class</span> <span class="nc">ReverseOneToOneDescriptor</span><span class="p">:</span>
<span class="linenos"> 389</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 390</span><span class="sd">    Accessor to the related object on the reverse side of a one-to-one</span>
<span class="linenos"> 391</span><span class="sd">    relation.</span>
<span class="linenos"> 392</span>
<span class="linenos"> 393</span><span class="sd">    In the example::</span>
<span class="linenos"> 394</span>
<span class="linenos"> 395</span><span class="sd">        class Restaurant(Model):</span>
<span class="linenos"> 396</span><span class="sd">            place = OneToOneField(Place, related_name=&#39;restaurant&#39;)</span>
<span class="linenos"> 397</span>
<span class="linenos"> 398</span><span class="sd">    ``Place.restaurant`` is a ``ReverseOneToOneDescriptor`` instance.</span>
<span class="linenos"> 399</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 400</span>
<span class="linenos"> 401</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">related</span><span class="p">):</span>
<span class="linenos"> 402</span>        <span class="c1"># Following the example above, `related` is an instance of OneToOneRel</span>
<span class="linenos"> 403</span>        <span class="c1"># which represents the reverse restaurant field (place.restaurant).</span>
<span class="linenos"> 404</span>        <span class="bp">self</span><span class="o">.</span><span class="n">related</span> <span class="o">=</span> <span class="n">related</span>
<span class="linenos"> 405</span>
<span class="linenos"> 406</span>    <span class="nd">@cached_property</span>
<span class="linenos"> 407</span>    <span class="k">def</span> <span class="nf">RelatedObjectDoesNotExist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 408</span>        <span class="c1"># The exception isn&#39;t created at initialization time for the sake of</span>
<span class="linenos"> 409</span>        <span class="c1"># consistency with `ForwardManyToOneDescriptor`.</span>
<span class="linenos"> 410</span>        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span>
<span class="linenos"> 411</span>            <span class="s2">&quot;RelatedObjectDoesNotExist&quot;</span><span class="p">,</span>
<span class="linenos"> 412</span>            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">),</span>
<span class="linenos"> 413</span>            <span class="p">{</span>
<span class="linenos"> 414</span>                <span class="s2">&quot;__module__&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
<span class="linenos"> 415</span>                <span class="s2">&quot;__qualname__&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.RelatedObjectDoesNotExist&quot;</span>
<span class="linenos"> 416</span>                <span class="o">%</span> <span class="p">(</span>
<span class="linenos"> 417</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
<span class="linenos"> 418</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="linenos"> 419</span>                <span class="p">),</span>
<span class="linenos"> 420</span>            <span class="p">},</span>
<span class="linenos"> 421</span>        <span class="p">)</span>
<span class="linenos"> 422</span>
<span class="linenos"> 423</span>    <span class="k">def</span> <span class="nf">is_cached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
<span class="linenos"> 424</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">is_cached</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 425</span>
<span class="linenos"> 426</span>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
<span class="linenos"> 427</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">_base_manager</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">hints</span><span class="o">=</span><span class="n">hints</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="linenos"> 428</span>
<span class="linenos"> 429</span>    <span class="k">def</span> <span class="nf">get_prefetch_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 430</span>        <span class="k">if</span> <span class="n">queryset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 431</span>            <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
<span class="linenos"> 432</span>        <span class="n">queryset</span><span class="o">.</span><span class="n">_add_hints</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instances</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos"> 433</span>
<span class="linenos"> 434</span>        <span class="n">rel_obj_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_local_related_value</span>
<span class="linenos"> 435</span>        <span class="n">instance_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_foreign_related_value</span>
<span class="linenos"> 436</span>        <span class="n">instances_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">instance_attr</span><span class="p">(</span><span class="n">inst</span><span class="p">):</span> <span class="n">inst</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">}</span>
<span class="linenos"> 437</span>        <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">__in&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">instances</span><span class="p">}</span>
<span class="linenos"> 438</span>        <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">query</span><span class="p">)</span>
<span class="linenos"> 439</span>
<span class="linenos"> 440</span>        <span class="c1"># Since we&#39;re going to assign directly in the cache,</span>
<span class="linenos"> 441</span>        <span class="c1"># we must manage the reverse relation cache manually.</span>
<span class="linenos"> 442</span>        <span class="k">for</span> <span class="n">rel_obj</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
<span class="linenos"> 443</span>            <span class="n">instance</span> <span class="o">=</span> <span class="n">instances_dict</span><span class="p">[</span><span class="n">rel_obj_attr</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">)]</span>
<span class="linenos"> 444</span>            <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 445</span>        <span class="k">return</span> <span class="p">(</span>
<span class="linenos"> 446</span>            <span class="n">queryset</span><span class="p">,</span>
<span class="linenos"> 447</span>            <span class="n">rel_obj_attr</span><span class="p">,</span>
<span class="linenos"> 448</span>            <span class="n">instance_attr</span><span class="p">,</span>
<span class="linenos"> 449</span>            <span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 450</span>            <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">get_cache_name</span><span class="p">(),</span>
<span class="linenos"> 451</span>            <span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 452</span>        <span class="p">)</span>
<span class="linenos"> 453</span>
<span class="linenos"> 454</span>    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 455</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 456</span><span class="sd">        Get the related instance through the reverse relation.</span>
<span class="linenos"> 457</span>
<span class="linenos"> 458</span><span class="sd">        With the example above, when getting ``place.restaurant``:</span>
<span class="linenos"> 459</span>
<span class="linenos"> 460</span><span class="sd">        - ``self`` is the descriptor managing the ``restaurant`` attribute</span>
<span class="linenos"> 461</span><span class="sd">        - ``instance`` is the ``place`` instance</span>
<span class="linenos"> 462</span><span class="sd">        - ``cls`` is the ``Place`` class (unused)</span>
<span class="linenos"> 463</span>
<span class="linenos"> 464</span><span class="sd">        Keep in mind that ``Restaurant`` holds the foreign key to ``Place``.</span>
<span class="linenos"> 465</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 466</span>        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 467</span>            <span class="k">return</span> <span class="bp">self</span>
<span class="linenos"> 468</span>
<span class="linenos"> 469</span>        <span class="c1"># The related instance is loaded from the database and then cached</span>
<span class="linenos"> 470</span>        <span class="c1"># by the field on the model instance state. It can also be pre-cached</span>
<span class="linenos"> 471</span>        <span class="c1"># by the forward accessor (ForwardManyToOneDescriptor).</span>
<span class="linenos"> 472</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 473</span>            <span class="n">rel_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">get_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 474</span>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
<span class="linenos"> 475</span>            <span class="n">related_pk</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">pk</span>
<span class="linenos"> 476</span>            <span class="k">if</span> <span class="n">related_pk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 477</span>                <span class="n">rel_obj</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 478</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 479</span>                <span class="n">filter_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_forward_related_filter</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 480</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 481</span>                    <span class="n">rel_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="n">filter_args</span><span class="p">)</span>
<span class="linenos"> 482</span>                <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
<span class="linenos"> 483</span>                    <span class="n">rel_obj</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 484</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 485</span>                    <span class="c1"># Set the forward accessor cache on the related object to</span>
<span class="linenos"> 486</span>                    <span class="c1"># the current instance to avoid an extra SQL query if it&#39;s</span>
<span class="linenos"> 487</span>                    <span class="c1"># accessed later on.</span>
<span class="linenos"> 488</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 489</span>            <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">rel_obj</span><span class="p">)</span>
<span class="linenos"> 490</span>
<span class="linenos"> 491</span>        <span class="k">if</span> <span class="n">rel_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 492</span>            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">RelatedObjectDoesNotExist</span><span class="p">(</span>
<span class="linenos"> 493</span>                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has no </span><span class="si">%s</span><span class="s2">.&quot;</span>
<span class="linenos"> 494</span>                <span class="o">%</span> <span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">())</span>
<span class="linenos"> 495</span>            <span class="p">)</span>
<span class="linenos"> 496</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 497</span>            <span class="k">return</span> <span class="n">rel_obj</span>
<span class="linenos"> 498</span>
<span class="linenos"> 499</span>    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos"> 500</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 501</span><span class="sd">        Set the related instance through the reverse relation.</span>
<span class="linenos"> 502</span>
<span class="linenos"> 503</span><span class="sd">        With the example above, when setting ``place.restaurant = restaurant``:</span>
<span class="linenos"> 504</span>
<span class="linenos"> 505</span><span class="sd">        - ``self`` is the descriptor managing the ``restaurant`` attribute</span>
<span class="linenos"> 506</span><span class="sd">        - ``instance`` is the ``place`` instance</span>
<span class="linenos"> 507</span><span class="sd">        - ``value`` is the ``restaurant`` instance on the right of the equal sign</span>
<span class="linenos"> 508</span>
<span class="linenos"> 509</span><span class="sd">        Keep in mind that ``Restaurant`` holds the foreign key to ``Place``.</span>
<span class="linenos"> 510</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 511</span>        <span class="c1"># The similarity of the code below to the code in</span>
<span class="linenos"> 512</span>        <span class="c1"># ForwardManyToOneDescriptor is annoying, but there&#39;s a bunch</span>
<span class="linenos"> 513</span>        <span class="c1"># of small differences that would make a common base class convoluted.</span>
<span class="linenos"> 514</span>
<span class="linenos"> 515</span>        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 516</span>            <span class="c1"># Update the cached related instance (if any) &amp; clear the cache.</span>
<span class="linenos"> 517</span>            <span class="c1"># Following the example above, this would be the cached</span>
<span class="linenos"> 518</span>            <span class="c1"># ``restaurant`` instance (if any).</span>
<span class="linenos"> 519</span>            <span class="n">rel_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">get_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 520</span>            <span class="k">if</span> <span class="n">rel_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 521</span>                <span class="c1"># Remove the ``restaurant`` instance from the ``place``</span>
<span class="linenos"> 522</span>                <span class="c1"># instance cache.</span>
<span class="linenos"> 523</span>                <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">delete_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 524</span>                <span class="c1"># Set the ``place`` field on the ``restaurant``</span>
<span class="linenos"> 525</span>                <span class="c1"># instance to None.</span>
<span class="linenos"> 526</span>                <span class="nb">setattr</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 527</span>        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">related_model</span><span class="p">):</span>
<span class="linenos"> 528</span>            <span class="c1"># An object must be an instance of the related class.</span>
<span class="linenos"> 529</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos"> 530</span>                <span class="s1">&#39;Cannot assign &quot;</span><span class="si">%r</span><span class="s1">&quot;: &quot;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&quot; must be a &quot;</span><span class="si">%s</span><span class="s1">&quot; instance.&#39;</span>
<span class="linenos"> 531</span>                <span class="o">%</span> <span class="p">(</span>
<span class="linenos"> 532</span>                    <span class="n">value</span><span class="p">,</span>
<span class="linenos"> 533</span>                    <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
<span class="linenos"> 534</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">(),</span>
<span class="linenos"> 535</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
<span class="linenos"> 536</span>                <span class="p">)</span>
<span class="linenos"> 537</span>            <span class="p">)</span>
<span class="linenos"> 538</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 539</span>            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 540</span>                <span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span>
<span class="linenos"> 541</span>                    <span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">value</span>
<span class="linenos"> 542</span>                <span class="p">)</span>
<span class="linenos"> 543</span>            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 544</span>                <span class="n">value</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span>
<span class="linenos"> 545</span>                    <span class="n">value</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span>
<span class="linenos"> 546</span>                <span class="p">)</span>
<span class="linenos"> 547</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">router</span><span class="o">.</span><span class="n">allow_relation</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
<span class="linenos"> 548</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos"> 549</span>                    <span class="s1">&#39;Cannot assign &quot;</span><span class="si">%r</span><span class="s1">&quot;: the current database router prevents this &#39;</span>
<span class="linenos"> 550</span>                    <span class="s2">&quot;relation.&quot;</span> <span class="o">%</span> <span class="n">value</span>
<span class="linenos"> 551</span>                <span class="p">)</span>
<span class="linenos"> 552</span>
<span class="linenos"> 553</span>            <span class="n">related_pk</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<span class="linenos"> 554</span>                <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span>
<span class="linenos"> 555</span>                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">foreign_related_fields</span>
<span class="linenos"> 556</span>            <span class="p">)</span>
<span class="linenos"> 557</span>            <span class="c1"># Set the value of the related field to the value of the related</span>
<span class="linenos"> 558</span>            <span class="c1"># object&#39;s related field.</span>
<span class="linenos"> 559</span>            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">local_related_fields</span><span class="p">):</span>
<span class="linenos"> 560</span>                <span class="nb">setattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="p">,</span> <span class="n">related_pk</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
<span class="linenos"> 561</span>
<span class="linenos"> 562</span>            <span class="c1"># Set the related instance cache used by __get__ to avoid an SQL query</span>
<span class="linenos"> 563</span>            <span class="c1"># when accessing the attribute we just set.</span>
<span class="linenos"> 564</span>            <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="linenos"> 565</span>
<span class="linenos"> 566</span>            <span class="c1"># Set the forward accessor cache on the related object to the current</span>
<span class="linenos"> 567</span>            <span class="c1"># instance to avoid an extra SQL query if it&#39;s accessed later on.</span>
<span class="linenos"> 568</span>            <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 569</span>
<span class="linenos"> 570</span>    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 571</span>        <span class="c1"># Same purpose as ForwardManyToOneDescriptor.__reduce__().</span>
<span class="linenos"> 572</span>        <span class="k">return</span> <span class="nb">getattr</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="linenos"> 573</span>
<span class="linenos"> 574</span>
<span class="linenos"> 575</span><span class="k">class</span> <span class="nc">ReverseManyToOneDescriptor</span><span class="p">:</span>
<span class="linenos"> 576</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 577</span><span class="sd">    Accessor to the related objects manager on the reverse side of a</span>
<span class="linenos"> 578</span><span class="sd">    many-to-one relation.</span>
<span class="linenos"> 579</span>
<span class="linenos"> 580</span><span class="sd">    In the example::</span>
<span class="linenos"> 581</span>
<span class="linenos"> 582</span><span class="sd">        class Child(Model):</span>
<span class="linenos"> 583</span><span class="sd">            parent = ForeignKey(Parent, related_name=&#39;children&#39;)</span>
<span class="linenos"> 584</span>
<span class="linenos"> 585</span><span class="sd">    ``Parent.children`` is a ``ReverseManyToOneDescriptor`` instance.</span>
<span class="linenos"> 586</span>
<span class="linenos"> 587</span><span class="sd">    Most of the implementation is delegated to a dynamically defined manager</span>
<span class="linenos"> 588</span><span class="sd">    class built by ``create_forward_many_to_many_manager()`` defined below.</span>
<span class="linenos"> 589</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 590</span>
<span class="linenos"> 591</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel</span><span class="p">):</span>
<span class="linenos"> 592</span>        <span class="bp">self</span><span class="o">.</span><span class="n">rel</span> <span class="o">=</span> <span class="n">rel</span>
<span class="linenos"> 593</span>        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span>
<span class="linenos"> 594</span>
<span class="linenos"> 595</span>    <span class="nd">@cached_property</span>
<span class="linenos"> 596</span>    <span class="k">def</span> <span class="nf">related_manager_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 597</span>        <span class="n">related_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">related_model</span>
<span class="linenos"> 598</span>
<span class="linenos"> 599</span>        <span class="k">return</span> <span class="n">create_reverse_many_to_one_manager</span><span class="p">(</span>
<span class="linenos"> 600</span>            <span class="n">related_model</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
<span class="linenos"> 601</span>            <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="p">,</span>
<span class="linenos"> 602</span>        <span class="p">)</span>
<span class="linenos"> 603</span>
<span class="linenos"> 604</span>    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 605</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 606</span><span class="sd">        Get the related objects through the reverse relation.</span>
<span class="linenos"> 607</span>
<span class="linenos"> 608</span><span class="sd">        With the example above, when getting ``parent.children``:</span>
<span class="linenos"> 609</span>
<span class="linenos"> 610</span><span class="sd">        - ``self`` is the descriptor managing the ``children`` attribute</span>
<span class="linenos"> 611</span><span class="sd">        - ``instance`` is the ``parent`` instance</span>
<span class="linenos"> 612</span><span class="sd">        - ``cls`` is the ``Parent`` class (unused)</span>
<span class="linenos"> 613</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 614</span>        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 615</span>            <span class="k">return</span> <span class="bp">self</span>
<span class="linenos"> 616</span>
<span class="linenos"> 617</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_manager_cls</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 618</span>
<span class="linenos"> 619</span>    <span class="k">def</span> <span class="nf">_get_set_deprecation_msg_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 620</span>        <span class="k">return</span> <span class="p">(</span>
<span class="linenos"> 621</span>            <span class="s2">&quot;reverse side of a related set&quot;</span><span class="p">,</span>
<span class="linenos"> 622</span>            <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">(),</span>
<span class="linenos"> 623</span>        <span class="p">)</span>
<span class="linenos"> 624</span>
<span class="linenos"> 625</span>    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos"> 626</span>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
<span class="linenos"> 627</span>            <span class="s2">&quot;Direct assignment to the </span><span class="si">%s</span><span class="s2"> is prohibited. Use </span><span class="si">%s</span><span class="s2">.set() instead.&quot;</span>
<span class="linenos"> 628</span>            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_set_deprecation_msg_params</span><span class="p">(),</span>
<span class="linenos"> 629</span>        <span class="p">)</span>
<span class="linenos"> 630</span>
<span class="linenos"> 631</span>
<span class="linenos"> 632</span><span class="k">def</span> <span class="nf">create_reverse_many_to_one_manager</span><span class="p">(</span><span class="n">superclass</span><span class="p">,</span> <span class="n">rel</span><span class="p">):</span>
<span class="linenos"> 633</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 634</span><span class="sd">    Create a manager for the reverse side of a many-to-one relation.</span>
<span class="linenos"> 635</span>
<span class="linenos"> 636</span><span class="sd">    This manager subclasses another manager, generally the default manager of</span>
<span class="linenos"> 637</span><span class="sd">    the related model, and adds behaviors specific to many-to-one relations.</span>
<span class="linenos"> 638</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 639</span>
<span class="linenos"> 640</span>    <span class="k">class</span> <span class="nc">RelatedManager</span><span class="p">(</span><span class="n">superclass</span><span class="p">,</span> <span class="n">AltersData</span><span class="p">):</span>
<span class="linenos"> 641</span>        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
<span class="linenos"> 642</span>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos"> 643</span>
<span class="linenos"> 644</span>            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span>
<span class="linenos"> 645</span>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">related_model</span>
<span class="linenos"> 646</span>            <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span>
<span class="linenos"> 647</span>
<span class="linenos"> 648</span>            <span class="bp">self</span><span class="o">.</span><span class="n">core_filters</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">instance</span><span class="p">}</span>
<span class="linenos"> 649</span>
<span class="linenos"> 650</span>        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">manager</span><span class="p">):</span>
<span class="linenos"> 651</span>            <span class="n">manager</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span>
<span class="linenos"> 652</span>            <span class="n">manager_class</span> <span class="o">=</span> <span class="n">create_reverse_many_to_one_manager</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">rel</span><span class="p">)</span>
<span class="linenos"> 653</span>            <span class="k">return</span> <span class="n">manager_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 654</span>
<span class="linenos"> 655</span>        <span class="n">do_not_call_in_templates</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 656</span>
<span class="linenos"> 657</span>        <span class="k">def</span> <span class="nf">_check_fk_val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 658</span>            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">foreign_related_fields</span><span class="p">:</span>
<span class="linenos"> 659</span>                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 660</span>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos"> 661</span>                        <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="si">!r}</span><span class="s1">&quot; needs to have a value for field &#39;</span>
<span class="linenos"> 662</span>                        <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="si">}</span><span class="s1">&quot; before this relationship can be used.&#39;</span>
<span class="linenos"> 663</span>                    <span class="p">)</span>
<span class="linenos"> 664</span>
<span class="linenos"> 665</span>        <span class="k">def</span> <span class="nf">_apply_rel_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
<span class="linenos"> 666</span><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 667</span><span class="sd">            Filter the queryset for the instance this manager is bound to.</span>
<span class="linenos"> 668</span><span class="sd">            &quot;&quot;&quot;</span>
<span class="linenos"> 669</span>            <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">or</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 670</span>            <span class="n">empty_strings_as_null</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span>
<span class="linenos"> 671</span>                <span class="n">db</span>
<span class="linenos"> 672</span>            <span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">interprets_empty_strings_as_nulls</span>
<span class="linenos"> 673</span>            <span class="n">queryset</span><span class="o">.</span><span class="n">_add_hints</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 674</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
<span class="linenos"> 675</span>                <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
<span class="linenos"> 676</span>            <span class="n">queryset</span><span class="o">.</span><span class="n">_defer_next_filter</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 677</span>            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">core_filters</span><span class="p">)</span>
<span class="linenos"> 678</span>            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">foreign_related_fields</span><span class="p">:</span>
<span class="linenos"> 679</span>                <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span>
<span class="linenos"> 680</span>                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">empty_strings_as_null</span><span class="p">):</span>
<span class="linenos"> 681</span>                    <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
<span class="linenos"> 682</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">many_to_one</span><span class="p">:</span>
<span class="linenos"> 683</span>                <span class="c1"># Guard against field-like objects such as GenericRelation</span>
<span class="linenos"> 684</span>                <span class="c1"># that abuse create_reverse_many_to_one_manager() with reverse</span>
<span class="linenos"> 685</span>                <span class="c1"># one-to-many relationships instead and break known related</span>
<span class="linenos"> 686</span>                <span class="c1"># objects assignment.</span>
<span class="linenos"> 687</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 688</span>                    <span class="n">target_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">target_field</span>
<span class="linenos"> 689</span>                <span class="k">except</span> <span class="n">FieldError</span><span class="p">:</span>
<span class="linenos"> 690</span>                    <span class="c1"># The relationship has multiple target fields. Use a tuple</span>
<span class="linenos"> 691</span>                    <span class="c1"># for related object id.</span>
<span class="linenos"> 692</span>                    <span class="n">rel_obj_id</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<span class="linenos"> 693</span>                        <span class="p">[</span>
<span class="linenos"> 694</span>                            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">target_field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span>
<span class="linenos"> 695</span>                            <span class="k">for</span> <span class="n">target_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">path_infos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">target_fields</span>
<span class="linenos"> 696</span>                        <span class="p">]</span>
<span class="linenos"> 697</span>                    <span class="p">)</span>
<span class="linenos"> 698</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 699</span>                    <span class="n">rel_obj_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">target_field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span>
<span class="linenos"> 700</span>                <span class="n">queryset</span><span class="o">.</span><span class="n">_known_related_objects</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 701</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">:</span> <span class="p">{</span><span class="n">rel_obj_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">}</span>
<span class="linenos"> 702</span>                <span class="p">}</span>
<span class="linenos"> 703</span>            <span class="k">return</span> <span class="n">queryset</span>
<span class="linenos"> 704</span>
<span class="linenos"> 705</span>        <span class="k">def</span> <span class="nf">_remove_prefetched_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 706</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 707</span>                <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">_prefetched_objects_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
<span class="linenos"> 708</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">get_cache_name</span><span class="p">()</span>
<span class="linenos"> 709</span>                <span class="p">)</span>
<span class="linenos"> 710</span>            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
<span class="linenos"> 711</span>                <span class="k">pass</span>  <span class="c1"># nothing to clear from cache</span>
<span class="linenos"> 712</span>
<span class="linenos"> 713</span>        <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 714</span>            <span class="c1"># Even if this relation is not to pk, we require still pk value.</span>
<span class="linenos"> 715</span>            <span class="c1"># The wish is that the instance has been already saved to DB,</span>
<span class="linenos"> 716</span>            <span class="c1"># although having a pk value isn&#39;t a guarantee of that.</span>
<span class="linenos"> 717</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">pk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 718</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos"> 719</span>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2"> instance needs to have a &quot;</span>
<span class="linenos"> 720</span>                    <span class="sa">f</span><span class="s2">&quot;primary key value before this relationship can be used.&quot;</span>
<span class="linenos"> 721</span>                <span class="p">)</span>
<span class="linenos"> 722</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 723</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">_prefetched_objects_cache</span><span class="p">[</span>
<span class="linenos"> 724</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">get_cache_name</span><span class="p">()</span>
<span class="linenos"> 725</span>                <span class="p">]</span>
<span class="linenos"> 726</span>            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
<span class="linenos"> 727</span>                <span class="n">queryset</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
<span class="linenos"> 728</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rel_filters</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>
<span class="linenos"> 729</span>
<span class="linenos"> 730</span>        <span class="k">def</span> <span class="nf">get_prefetch_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 731</span>            <span class="k">if</span> <span class="n">queryset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 732</span>                <span class="n">queryset</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
<span class="linenos"> 733</span>
<span class="linenos"> 734</span>            <span class="n">queryset</span><span class="o">.</span><span class="n">_add_hints</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instances</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos"> 735</span>            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">queryset</span><span class="o">.</span><span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
<span class="linenos"> 736</span>
<span class="linenos"> 737</span>            <span class="n">rel_obj_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_local_related_value</span>
<span class="linenos"> 738</span>            <span class="n">instance_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_foreign_related_value</span>
<span class="linenos"> 739</span>            <span class="n">instances_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">instance_attr</span><span class="p">(</span><span class="n">inst</span><span class="p">):</span> <span class="n">inst</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">}</span>
<span class="linenos"> 740</span>            <span class="n">queryset</span> <span class="o">=</span> <span class="n">_filter_prefetch_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">instances</span><span class="p">)</span>
<span class="linenos"> 741</span>
<span class="linenos"> 742</span>            <span class="c1"># Since we just bypassed this class&#39; get_queryset(), we must manage</span>
<span class="linenos"> 743</span>            <span class="c1"># the reverse relation manually.</span>
<span class="linenos"> 744</span>            <span class="k">for</span> <span class="n">rel_obj</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
<span class="linenos"> 745</span>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">is_cached</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">):</span>
<span class="linenos"> 746</span>                    <span class="n">instance</span> <span class="o">=</span> <span class="n">instances_dict</span><span class="p">[</span><span class="n">rel_obj_attr</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">)]</span>
<span class="linenos"> 747</span>                    <span class="nb">setattr</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 748</span>            <span class="n">cache_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">get_cache_name</span><span class="p">()</span>
<span class="linenos"> 749</span>            <span class="k">return</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">rel_obj_attr</span><span class="p">,</span> <span class="n">instance_attr</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cache_name</span><span class="p">,</span> <span class="kc">False</span>
<span class="linenos"> 750</span>
<span class="linenos"> 751</span>        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="linenos"> 752</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_check_fk_val</span><span class="p">()</span>
<span class="linenos"> 753</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_prefetched_objects</span><span class="p">()</span>
<span class="linenos"> 754</span>            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 755</span>
<span class="linenos"> 756</span>            <span class="k">def</span> <span class="nf">check_and_update_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<span class="linenos"> 757</span>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">):</span>
<span class="linenos"> 758</span>                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
<span class="linenos"> 759</span>                        <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; instance expected, got </span><span class="si">%r</span><span class="s2">&quot;</span>
<span class="linenos"> 760</span>                        <span class="o">%</span> <span class="p">(</span>
<span class="linenos"> 761</span>                            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
<span class="linenos"> 762</span>                            <span class="n">obj</span><span class="p">,</span>
<span class="linenos"> 763</span>                        <span class="p">)</span>
<span class="linenos"> 764</span>                    <span class="p">)</span>
<span class="linenos"> 765</span>                <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 766</span>
<span class="linenos"> 767</span>            <span class="k">if</span> <span class="n">bulk</span><span class="p">:</span>
<span class="linenos"> 768</span>                <span class="n">pks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 769</span>                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
<span class="linenos"> 770</span>                    <span class="n">check_and_update_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="linenos"> 771</span>                    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">adding</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="o">!=</span> <span class="n">db</span><span class="p">:</span>
<span class="linenos"> 772</span>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos"> 773</span>                            <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> instance isn&#39;t saved. Use bulk=False or save &quot;</span>
<span class="linenos"> 774</span>                            <span class="s2">&quot;the object first.&quot;</span> <span class="o">%</span> <span class="n">obj</span>
<span class="linenos"> 775</span>                        <span class="p">)</span>
<span class="linenos"> 776</span>                    <span class="n">pks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
<span class="linenos"> 777</span>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_base_manager</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">pks</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<span class="linenos"> 778</span>                    <span class="o">**</span><span class="p">{</span>
<span class="linenos"> 779</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
<span class="linenos"> 780</span>                    <span class="p">}</span>
<span class="linenos"> 781</span>                <span class="p">)</span>
<span class="linenos"> 782</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 783</span>                <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 784</span>                    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
<span class="linenos"> 785</span>                        <span class="n">check_and_update_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="linenos"> 786</span>                        <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="linenos"> 787</span>
<span class="linenos"> 788</span>        <span class="n">add</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 789</span>
<span class="linenos"> 790</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">aadd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="linenos"> 791</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">)(</span><span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
<span class="linenos"> 792</span>
<span class="linenos"> 793</span>        <span class="n">aadd</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 794</span>
<span class="linenos"> 795</span>        <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos"> 796</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_check_fk_val</span><span class="p">()</span>
<span class="linenos"> 797</span>            <span class="n">kwargs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span>
<span class="linenos"> 798</span>            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 799</span>            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RelatedManager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">db</span><span class="p">))</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 800</span>
<span class="linenos"> 801</span>        <span class="n">create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 802</span>
<span class="linenos"> 803</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">acreate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos"> 804</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 805</span>
<span class="linenos"> 806</span>        <span class="n">acreate</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 807</span>
<span class="linenos"> 808</span>        <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos"> 809</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_check_fk_val</span><span class="p">()</span>
<span class="linenos"> 810</span>            <span class="n">kwargs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span>
<span class="linenos"> 811</span>            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 812</span>            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RelatedManager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">db</span><span class="p">))</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 813</span>
<span class="linenos"> 814</span>        <span class="n">get_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 815</span>
<span class="linenos"> 816</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">aget_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos"> 817</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 818</span>
<span class="linenos"> 819</span>        <span class="n">aget_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 820</span>
<span class="linenos"> 821</span>        <span class="k">def</span> <span class="nf">update_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos"> 822</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_check_fk_val</span><span class="p">()</span>
<span class="linenos"> 823</span>            <span class="n">kwargs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span>
<span class="linenos"> 824</span>            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 825</span>            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RelatedManager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">db</span><span class="p">))</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 826</span>
<span class="linenos"> 827</span>        <span class="n">update_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 828</span>
<span class="linenos"> 829</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">aupdate_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos"> 830</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos"> 831</span>
<span class="linenos"> 832</span>        <span class="n">aupdate_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 833</span>
<span class="linenos"> 834</span>        <span class="c1"># remove() and clear() are only provided if the ForeignKey can have a</span>
<span class="linenos"> 835</span>        <span class="c1"># value of null.</span>
<span class="linenos"> 836</span>        <span class="k">if</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">null</span><span class="p">:</span>
<span class="linenos"> 837</span>
<span class="linenos"> 838</span>            <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="linenos"> 839</span>                <span class="k">if</span> <span class="ow">not</span> <span class="n">objs</span><span class="p">:</span>
<span class="linenos"> 840</span>                    <span class="k">return</span>
<span class="linenos"> 841</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_check_fk_val</span><span class="p">()</span>
<span class="linenos"> 842</span>                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_foreign_related_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 843</span>                <span class="n">old_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="linenos"> 844</span>                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
<span class="linenos"> 845</span>                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">):</span>
<span class="linenos"> 846</span>                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
<span class="linenos"> 847</span>                            <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; instance expected, got </span><span class="si">%r</span><span class="s2">&quot;</span>
<span class="linenos"> 848</span>                            <span class="o">%</span> <span class="p">(</span>
<span class="linenos"> 849</span>                                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
<span class="linenos"> 850</span>                                <span class="n">obj</span><span class="p">,</span>
<span class="linenos"> 851</span>                            <span class="p">)</span>
<span class="linenos"> 852</span>                        <span class="p">)</span>
<span class="linenos"> 853</span>                    <span class="c1"># Is obj actually part of this descriptor set?</span>
<span class="linenos"> 854</span>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_local_related_value</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">:</span>
<span class="linenos"> 855</span>                        <span class="n">old_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
<span class="linenos"> 856</span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 857</span>                        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">(</span>
<span class="linenos"> 858</span>                            <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> is not related to </span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 859</span>                        <span class="p">)</span>
<span class="linenos"> 860</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">old_ids</span><span class="p">),</span> <span class="n">bulk</span><span class="p">)</span>
<span class="linenos"> 861</span>
<span class="linenos"> 862</span>            <span class="n">remove</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 863</span>
<span class="linenos"> 864</span>            <span class="k">async</span> <span class="k">def</span> <span class="nf">aremove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="linenos"> 865</span>                <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">)(</span><span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
<span class="linenos"> 866</span>
<span class="linenos"> 867</span>            <span class="n">aremove</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 868</span>
<span class="linenos"> 869</span>            <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="linenos"> 870</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_check_fk_val</span><span class="p">()</span>
<span class="linenos"> 871</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bulk</span><span class="p">)</span>
<span class="linenos"> 872</span>
<span class="linenos"> 873</span>            <span class="n">clear</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 874</span>
<span class="linenos"> 875</span>            <span class="k">async</span> <span class="k">def</span> <span class="nf">aclear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="linenos"> 876</span>                <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">)(</span><span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
<span class="linenos"> 877</span>
<span class="linenos"> 878</span>            <span class="n">aclear</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 879</span>
<span class="linenos"> 880</span>            <span class="k">def</span> <span class="nf">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">bulk</span><span class="p">):</span>
<span class="linenos"> 881</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_remove_prefetched_objects</span><span class="p">()</span>
<span class="linenos"> 882</span>                <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 883</span>                <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="linenos"> 884</span>                <span class="k">if</span> <span class="n">bulk</span><span class="p">:</span>
<span class="linenos"> 885</span>                    <span class="c1"># `QuerySet.update()` is intrinsically atomic.</span>
<span class="linenos"> 886</span>                    <span class="n">queryset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
<span class="linenos"> 887</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 888</span>                    <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 889</span>                        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
<span class="linenos"> 890</span>                            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 891</span>                            <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">update_fields</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
<span class="linenos"> 892</span>
<span class="linenos"> 893</span>            <span class="n">_clear</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 894</span>
<span class="linenos"> 895</span>        <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objs</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 896</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_check_fk_val</span><span class="p">()</span>
<span class="linenos"> 897</span>            <span class="c1"># Force evaluation of `objs` in case it&#39;s a queryset whose value</span>
<span class="linenos"> 898</span>            <span class="c1"># could be affected by `manager.clear()`. Refs #19816.</span>
<span class="linenos"> 899</span>            <span class="n">objs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
<span class="linenos"> 900</span>
<span class="linenos"> 901</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">null</span><span class="p">:</span>
<span class="linenos"> 902</span>                <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos"> 903</span>                <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 904</span>                    <span class="k">if</span> <span class="n">clear</span><span class="p">:</span>
<span class="linenos"> 905</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
<span class="linenos"> 906</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
<span class="linenos"> 907</span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 908</span>                        <span class="n">old_objs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="linenos"> 909</span>                        <span class="n">new_objs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 910</span>                        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
<span class="linenos"> 911</span>                            <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">old_objs</span><span class="p">:</span>
<span class="linenos"> 912</span>                                <span class="n">old_objs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="linenos"> 913</span>                            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 914</span>                                <span class="n">new_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="linenos"> 915</span>
<span class="linenos"> 916</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="o">*</span><span class="n">old_objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
<span class="linenos"> 917</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">new_objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
<span class="linenos"> 918</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 919</span>                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
<span class="linenos"> 920</span>
<span class="linenos"> 921</span>        <span class="nb">set</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 922</span>
<span class="linenos"> 923</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">aset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objs</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 924</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">)(</span><span class="n">objs</span><span class="o">=</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="n">clear</span><span class="p">)</span>
<span class="linenos"> 925</span>
<span class="linenos"> 926</span>        <span class="n">aset</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 927</span>
<span class="linenos"> 928</span>    <span class="k">return</span> <span class="n">RelatedManager</span>
<span class="linenos"> 929</span>
<span class="linenos"> 930</span>
<span class="linenos"> 931</span><span class="k">class</span> <span class="nc">ManyToManyDescriptor</span><span class="p">(</span><span class="n">ReverseManyToOneDescriptor</span><span class="p">):</span>
<span class="linenos"> 932</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 933</span><span class="sd">    Accessor to the related objects manager on the forward and reverse sides of</span>
<span class="linenos"> 934</span><span class="sd">    a many-to-many relation.</span>
<span class="linenos"> 935</span>
<span class="linenos"> 936</span><span class="sd">    In the example::</span>
<span class="linenos"> 937</span>
<span class="linenos"> 938</span><span class="sd">        class Pizza(Model):</span>
<span class="linenos"> 939</span><span class="sd">            toppings = ManyToManyField(Topping, related_name=&#39;pizzas&#39;)</span>
<span class="linenos"> 940</span>
<span class="linenos"> 941</span><span class="sd">    ``Pizza.toppings`` and ``Topping.pizzas`` are ``ManyToManyDescriptor``</span>
<span class="linenos"> 942</span><span class="sd">    instances.</span>
<span class="linenos"> 943</span>
<span class="linenos"> 944</span><span class="sd">    Most of the implementation is delegated to a dynamically defined manager</span>
<span class="linenos"> 945</span><span class="sd">    class built by ``create_forward_many_to_many_manager()`` defined below.</span>
<span class="linenos"> 946</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 947</span>
<span class="linenos"> 948</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 949</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>
<span class="linenos"> 950</span>
<span class="linenos"> 951</span>        <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span> <span class="o">=</span> <span class="n">reverse</span>
<span class="linenos"> 952</span>
<span class="linenos"> 953</span>    <span class="nd">@property</span>
<span class="linenos"> 954</span>    <span class="k">def</span> <span class="nf">through</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 955</span>        <span class="c1"># through is provided so that you have easy access to the through</span>
<span class="linenos"> 956</span>        <span class="c1"># model (Book.authors.through) for inlines, etc. This is done as</span>
<span class="linenos"> 957</span>        <span class="c1"># a property to ensure that the fully resolved value is returned.</span>
<span class="linenos"> 958</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span>
<span class="linenos"> 959</span>
<span class="linenos"> 960</span>    <span class="nd">@cached_property</span>
<span class="linenos"> 961</span>    <span class="k">def</span> <span class="nf">related_manager_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 962</span>        <span class="n">related_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">related_model</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">model</span>
<span class="linenos"> 963</span>
<span class="linenos"> 964</span>        <span class="k">return</span> <span class="n">create_forward_many_to_many_manager</span><span class="p">(</span>
<span class="linenos"> 965</span>            <span class="n">related_model</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
<span class="linenos"> 966</span>            <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="p">,</span>
<span class="linenos"> 967</span>            <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span>
<span class="linenos"> 968</span>        <span class="p">)</span>
<span class="linenos"> 969</span>
<span class="linenos"> 970</span>    <span class="k">def</span> <span class="nf">_get_set_deprecation_msg_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 971</span>        <span class="k">return</span> <span class="p">(</span>
<span class="linenos"> 972</span>            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> side of a many-to-many set&quot;</span>
<span class="linenos"> 973</span>            <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;reverse&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span> <span class="k">else</span> <span class="s2">&quot;forward&quot;</span><span class="p">),</span>
<span class="linenos"> 974</span>            <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="linenos"> 975</span>        <span class="p">)</span>
<span class="linenos"> 976</span>
<span class="linenos"> 977</span>
<span class="linenos"> 978</span><span class="k">def</span> <span class="nf">create_forward_many_to_many_manager</span><span class="p">(</span><span class="n">superclass</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
<span class="linenos"> 979</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 980</span><span class="sd">    Create a manager for the either side of a many-to-many relation.</span>
<span class="linenos"> 981</span>
<span class="linenos"> 982</span><span class="sd">    This manager subclasses another manager, generally the default manager of</span>
<span class="linenos"> 983</span><span class="sd">    the related model, and adds behaviors specific to many-to-many relations.</span>
<span class="linenos"> 984</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 985</span>
<span class="linenos"> 986</span>    <span class="k">class</span> <span class="nc">ManyRelatedManager</span><span class="p">(</span><span class="n">superclass</span><span class="p">,</span> <span class="n">AltersData</span><span class="p">):</span>
<span class="linenos"> 987</span>        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 988</span>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos"> 989</span>
<span class="linenos"> 990</span>            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span>
<span class="linenos"> 991</span>
<span class="linenos"> 992</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span>
<span class="linenos"> 993</span>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">model</span>
<span class="linenos"> 994</span>                <span class="bp">self</span><span class="o">.</span><span class="n">query_field_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">related_query_name</span><span class="p">()</span>
<span class="linenos"> 995</span>                <span class="bp">self</span><span class="o">.</span><span class="n">prefetch_cache_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span>
<span class="linenos"> 996</span>                <span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">m2m_field_name</span><span class="p">()</span>
<span class="linenos"> 997</span>                <span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">m2m_reverse_field_name</span><span class="p">()</span>
<span class="linenos"> 998</span>                <span class="bp">self</span><span class="o">.</span><span class="n">symmetrical</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">symmetrical</span>
<span class="linenos"> 999</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1000</span>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">related_model</span>
<span class="linenos">1001</span>                <span class="bp">self</span><span class="o">.</span><span class="n">query_field_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span>
<span class="linenos">1002</span>                <span class="bp">self</span><span class="o">.</span><span class="n">prefetch_cache_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">related_query_name</span><span class="p">()</span>
<span class="linenos">1003</span>                <span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">m2m_reverse_field_name</span><span class="p">()</span>
<span class="linenos">1004</span>                <span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">m2m_field_name</span><span class="p">()</span>
<span class="linenos">1005</span>                <span class="bp">self</span><span class="o">.</span><span class="n">symmetrical</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1006</span>
<span class="linenos">1007</span>            <span class="bp">self</span><span class="o">.</span><span class="n">through</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">through</span>
<span class="linenos">1008</span>            <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span> <span class="o">=</span> <span class="n">reverse</span>
<span class="linenos">1009</span>
<span class="linenos">1010</span>            <span class="bp">self</span><span class="o">.</span><span class="n">source_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="p">)</span>
<span class="linenos">1011</span>            <span class="bp">self</span><span class="o">.</span><span class="n">target_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span><span class="p">)</span>
<span class="linenos">1012</span>
<span class="linenos">1013</span>            <span class="bp">self</span><span class="o">.</span><span class="n">core_filters</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">1014</span>            <span class="bp">self</span><span class="o">.</span><span class="n">pk_field_names</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">1015</span>            <span class="k">for</span> <span class="n">lh_field</span><span class="p">,</span> <span class="n">rh_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_field</span><span class="o">.</span><span class="n">related_fields</span><span class="p">:</span>
<span class="linenos">1016</span>                <span class="n">core_filter_key</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">__</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_field_name</span><span class="p">,</span> <span class="n">rh_field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="linenos">1017</span>                <span class="bp">self</span><span class="o">.</span><span class="n">core_filters</span><span class="p">[</span><span class="n">core_filter_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">rh_field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span>
<span class="linenos">1018</span>                <span class="bp">self</span><span class="o">.</span><span class="n">pk_field_names</span><span class="p">[</span><span class="n">lh_field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rh_field</span><span class="o">.</span><span class="n">name</span>
<span class="linenos">1019</span>
<span class="linenos">1020</span>            <span class="bp">self</span><span class="o">.</span><span class="n">related_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_field</span><span class="o">.</span><span class="n">get_foreign_related_value</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos">1021</span>            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_val</span><span class="p">:</span>
<span class="linenos">1022</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">1023</span>                    <span class="s1">&#39;&quot;</span><span class="si">%r</span><span class="s1">&quot; needs to have a value for field &quot;</span><span class="si">%s</span><span class="s1">&quot; before &#39;</span>
<span class="linenos">1024</span>                    <span class="s2">&quot;this many-to-many relationship can be used.&quot;</span>
<span class="linenos">1025</span>                    <span class="o">%</span> <span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk_field_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="p">])</span>
<span class="linenos">1026</span>                <span class="p">)</span>
<span class="linenos">1027</span>            <span class="c1"># Even if this relation is not to pk, we require still pk value.</span>
<span class="linenos">1028</span>            <span class="c1"># The wish is that the instance has been already saved to DB,</span>
<span class="linenos">1029</span>            <span class="c1"># although having a pk value isn&#39;t a guarantee of that.</span>
<span class="linenos">1030</span>            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">pk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1031</span>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">1032</span>                    <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> instance needs to have a primary key value before &quot;</span>
<span class="linenos">1033</span>                    <span class="s2">&quot;a many-to-many relationship can be used.&quot;</span>
<span class="linenos">1034</span>                    <span class="o">%</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
<span class="linenos">1035</span>                <span class="p">)</span>
<span class="linenos">1036</span>
<span class="linenos">1037</span>        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">manager</span><span class="p">):</span>
<span class="linenos">1038</span>            <span class="n">manager</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span>
<span class="linenos">1039</span>            <span class="n">manager_class</span> <span class="o">=</span> <span class="n">create_forward_many_to_many_manager</span><span class="p">(</span>
<span class="linenos">1040</span>                <span class="n">manager</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="n">reverse</span>
<span class="linenos">1041</span>            <span class="p">)</span>
<span class="linenos">1042</span>            <span class="k">return</span> <span class="n">manager_class</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos">1043</span>
<span class="linenos">1044</span>        <span class="n">do_not_call_in_templates</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1045</span>
<span class="linenos">1046</span>        <span class="k">def</span> <span class="nf">_build_remove_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">removed_vals</span><span class="p">):</span>
<span class="linenos">1047</span>            <span class="n">filters</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">create</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_val</span><span class="p">)])</span>
<span class="linenos">1048</span>            <span class="c1"># No need to add a subquery condition if removed_vals is a QuerySet without</span>
<span class="linenos">1049</span>            <span class="c1"># filters.</span>
<span class="linenos">1050</span>            <span class="n">removed_vals_filters</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">1051</span>                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">removed_vals</span><span class="p">,</span> <span class="n">QuerySet</span><span class="p">)</span> <span class="ow">or</span> <span class="n">removed_vals</span><span class="o">.</span><span class="n">_has_filters</span><span class="p">()</span>
<span class="linenos">1052</span>            <span class="p">)</span>
<span class="linenos">1053</span>            <span class="k">if</span> <span class="n">removed_vals_filters</span><span class="p">:</span>
<span class="linenos">1054</span>                <span class="n">filters</span> <span class="o">&amp;=</span> <span class="n">Q</span><span class="o">.</span><span class="n">create</span><span class="p">([(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span><span class="si">}</span><span class="s2">__in&quot;</span><span class="p">,</span> <span class="n">removed_vals</span><span class="p">)])</span>
<span class="linenos">1055</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrical</span><span class="p">:</span>
<span class="linenos">1056</span>                <span class="n">symmetrical_filters</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<span class="linenos">1057</span>                    <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_val</span><span class="p">)]</span>
<span class="linenos">1058</span>                <span class="p">)</span>
<span class="linenos">1059</span>                <span class="k">if</span> <span class="n">removed_vals_filters</span><span class="p">:</span>
<span class="linenos">1060</span>                    <span class="n">symmetrical_filters</span> <span class="o">&amp;=</span> <span class="n">Q</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<span class="linenos">1061</span>                        <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="si">}</span><span class="s2">__in&quot;</span><span class="p">,</span> <span class="n">removed_vals</span><span class="p">)]</span>
<span class="linenos">1062</span>                    <span class="p">)</span>
<span class="linenos">1063</span>                <span class="n">filters</span> <span class="o">|=</span> <span class="n">symmetrical_filters</span>
<span class="linenos">1064</span>            <span class="k">return</span> <span class="n">filters</span>
<span class="linenos">1065</span>
<span class="linenos">1066</span>        <span class="k">def</span> <span class="nf">_apply_rel_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
<span class="linenos">1067</span><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1068</span><span class="sd">            Filter the queryset for the instance this manager is bound to.</span>
<span class="linenos">1069</span><span class="sd">            &quot;&quot;&quot;</span>
<span class="linenos">1070</span>            <span class="n">queryset</span><span class="o">.</span><span class="n">_add_hints</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos">1071</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
<span class="linenos">1072</span>                <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
<span class="linenos">1073</span>            <span class="n">queryset</span><span class="o">.</span><span class="n">_defer_next_filter</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1074</span>            <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">_next_is_sticky</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">core_filters</span><span class="p">)</span>
<span class="linenos">1075</span>
<span class="linenos">1076</span>        <span class="k">def</span> <span class="nf">_remove_prefetched_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1077</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">1078</span>                <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">_prefetched_objects_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefetch_cache_name</span><span class="p">)</span>
<span class="linenos">1079</span>            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
<span class="linenos">1080</span>                <span class="k">pass</span>  <span class="c1"># nothing to clear from cache</span>
<span class="linenos">1081</span>
<span class="linenos">1082</span>        <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1083</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">1084</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">_prefetched_objects_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prefetch_cache_name</span><span class="p">]</span>
<span class="linenos">1085</span>            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
<span class="linenos">1086</span>                <span class="n">queryset</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
<span class="linenos">1087</span>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rel_filters</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>
<span class="linenos">1088</span>
<span class="linenos">1089</span>        <span class="k">def</span> <span class="nf">get_prefetch_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">1090</span>            <span class="k">if</span> <span class="n">queryset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1091</span>                <span class="n">queryset</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
<span class="linenos">1092</span>
<span class="linenos">1093</span>            <span class="n">queryset</span><span class="o">.</span><span class="n">_add_hints</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instances</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">1094</span>            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">queryset</span><span class="o">.</span><span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
<span class="linenos">1095</span>            <span class="n">queryset</span> <span class="o">=</span> <span class="n">_filter_prefetch_queryset</span><span class="p">(</span>
<span class="linenos">1096</span>                <span class="n">queryset</span><span class="o">.</span><span class="n">_next_is_sticky</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_field_name</span><span class="p">,</span> <span class="n">instances</span>
<span class="linenos">1097</span>            <span class="p">)</span>
<span class="linenos">1098</span>
<span class="linenos">1099</span>            <span class="c1"># M2M: need to annotate the query in order to get the primary model</span>
<span class="linenos">1100</span>            <span class="c1"># that the secondary model was actually related to. We know that</span>
<span class="linenos">1101</span>            <span class="c1"># there will already be a join on the join table, so we can just add</span>
<span class="linenos">1102</span>            <span class="c1"># the select.</span>
<span class="linenos">1103</span>
<span class="linenos">1104</span>            <span class="c1"># For non-autocreated &#39;through&#39; models, can&#39;t assume we are</span>
<span class="linenos">1105</span>            <span class="c1"># dealing with PK values.</span>
<span class="linenos">1106</span>            <span class="n">fk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="p">)</span>
<span class="linenos">1107</span>            <span class="n">join_table</span> <span class="o">=</span> <span class="n">fk</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span>
<span class="linenos">1108</span>            <span class="n">connection</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">queryset</span><span class="o">.</span><span class="n">db</span><span class="p">]</span>
<span class="linenos">1109</span>            <span class="n">qn</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">quote_name</span>
<span class="linenos">1110</span>            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span>
<span class="linenos">1111</span>                <span class="n">select</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">1112</span>                    <span class="s2">&quot;_prefetch_related_val_</span><span class="si">%s</span><span class="s2">&quot;</span>
<span class="linenos">1113</span>                    <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">attname</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span>
<span class="linenos">1114</span>                    <span class="o">%</span> <span class="p">(</span><span class="n">qn</span><span class="p">(</span><span class="n">join_table</span><span class="p">),</span> <span class="n">qn</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">column</span><span class="p">))</span>
<span class="linenos">1115</span>                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fk</span><span class="o">.</span><span class="n">local_related_fields</span>
<span class="linenos">1116</span>                <span class="p">}</span>
<span class="linenos">1117</span>            <span class="p">)</span>
<span class="linenos">1118</span>            <span class="k">return</span> <span class="p">(</span>
<span class="linenos">1119</span>                <span class="n">queryset</span><span class="p">,</span>
<span class="linenos">1120</span>                <span class="k">lambda</span> <span class="n">result</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span>
<span class="linenos">1121</span>                    <span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;_prefetch_related_val_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span>
<span class="linenos">1122</span>                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fk</span><span class="o">.</span><span class="n">local_related_fields</span>
<span class="linenos">1123</span>                <span class="p">),</span>
<span class="linenos">1124</span>                <span class="k">lambda</span> <span class="n">inst</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span>
<span class="linenos">1125</span>                    <span class="n">f</span><span class="o">.</span><span class="n">get_db_prep_value</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">attname</span><span class="p">),</span> <span class="n">connection</span><span class="p">)</span>
<span class="linenos">1126</span>                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fk</span><span class="o">.</span><span class="n">foreign_related_fields</span>
<span class="linenos">1127</span>                <span class="p">),</span>
<span class="linenos">1128</span>                <span class="kc">False</span><span class="p">,</span>
<span class="linenos">1129</span>                <span class="bp">self</span><span class="o">.</span><span class="n">prefetch_cache_name</span><span class="p">,</span>
<span class="linenos">1130</span>                <span class="kc">False</span><span class="p">,</span>
<span class="linenos">1131</span>            <span class="p">)</span>
<span class="linenos">1132</span>
<span class="linenos">1133</span>        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">1134</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_prefetched_objects</span><span class="p">()</span>
<span class="linenos">1135</span>            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos">1136</span>            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">1137</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_add_items</span><span class="p">(</span>
<span class="linenos">1138</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="p">,</span>
<span class="linenos">1139</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span><span class="p">,</span>
<span class="linenos">1140</span>                    <span class="o">*</span><span class="n">objs</span><span class="p">,</span>
<span class="linenos">1141</span>                    <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">,</span>
<span class="linenos">1142</span>                <span class="p">)</span>
<span class="linenos">1143</span>                <span class="c1"># If this is a symmetrical m2m relation to self, add the mirror</span>
<span class="linenos">1144</span>                <span class="c1"># entry in the m2m table.</span>
<span class="linenos">1145</span>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrical</span><span class="p">:</span>
<span class="linenos">1146</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_items</span><span class="p">(</span>
<span class="linenos">1147</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span><span class="p">,</span>
<span class="linenos">1148</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="p">,</span>
<span class="linenos">1149</span>                        <span class="o">*</span><span class="n">objs</span><span class="p">,</span>
<span class="linenos">1150</span>                        <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">,</span>
<span class="linenos">1151</span>                    <span class="p">)</span>
<span class="linenos">1152</span>
<span class="linenos">1153</span>        <span class="n">add</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1154</span>
<span class="linenos">1155</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">aadd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">1156</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">)(</span>
<span class="linenos">1157</span>                <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span>
<span class="linenos">1158</span>            <span class="p">)</span>
<span class="linenos">1159</span>
<span class="linenos">1160</span>        <span class="n">aadd</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1161</span>
<span class="linenos">1162</span>        <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">):</span>
<span class="linenos">1163</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_prefetched_objects</span><span class="p">()</span>
<span class="linenos">1164</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_items</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">)</span>
<span class="linenos">1165</span>
<span class="linenos">1166</span>        <span class="n">remove</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1167</span>
<span class="linenos">1168</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">aremove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">):</span>
<span class="linenos">1169</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">)(</span><span class="o">*</span><span class="n">objs</span><span class="p">)</span>
<span class="linenos">1170</span>
<span class="linenos">1171</span>        <span class="n">aremove</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1172</span>
<span class="linenos">1173</span>        <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1174</span>            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos">1175</span>            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">1176</span>                <span class="n">signals</span><span class="o">.</span><span class="n">m2m_changed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
<span class="linenos">1177</span>                    <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span>
<span class="linenos">1178</span>                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;pre_clear&quot;</span><span class="p">,</span>
<span class="linenos">1179</span>                    <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
<span class="linenos">1180</span>                    <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span>
<span class="linenos">1181</span>                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
<span class="linenos">1182</span>                    <span class="n">pk_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos">1183</span>                    <span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
<span class="linenos">1184</span>                <span class="p">)</span>
<span class="linenos">1185</span>                <span class="bp">self</span><span class="o">.</span><span class="n">_remove_prefetched_objects</span><span class="p">()</span>
<span class="linenos">1186</span>                <span class="n">filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_remove_filters</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
<span class="linenos">1187</span>                <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="linenos">1188</span>
<span class="linenos">1189</span>                <span class="n">signals</span><span class="o">.</span><span class="n">m2m_changed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
<span class="linenos">1190</span>                    <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span>
<span class="linenos">1191</span>                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;post_clear&quot;</span><span class="p">,</span>
<span class="linenos">1192</span>                    <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
<span class="linenos">1193</span>                    <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span>
<span class="linenos">1194</span>                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
<span class="linenos">1195</span>                    <span class="n">pk_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos">1196</span>                    <span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
<span class="linenos">1197</span>                <span class="p">)</span>
<span class="linenos">1198</span>
<span class="linenos">1199</span>        <span class="n">clear</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1200</span>
<span class="linenos">1201</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">aclear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1202</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">)()</span>
<span class="linenos">1203</span>
<span class="linenos">1204</span>        <span class="n">aclear</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1205</span>
<span class="linenos">1206</span>        <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objs</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">1207</span>            <span class="c1"># Force evaluation of `objs` in case it&#39;s a queryset whose value</span>
<span class="linenos">1208</span>            <span class="c1"># could be affected by `manager.clear()`. Refs #19816.</span>
<span class="linenos">1209</span>            <span class="n">objs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
<span class="linenos">1210</span>
<span class="linenos">1211</span>            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos">1212</span>            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">1213</span>                <span class="k">if</span> <span class="n">clear</span><span class="p">:</span>
<span class="linenos">1214</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="linenos">1215</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">)</span>
<span class="linenos">1216</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">1217</span>                    <span class="n">old_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
<span class="linenos">1218</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
<span class="linenos">1219</span>                            <span class="bp">self</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">attname</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos">1220</span>                        <span class="p">)</span>
<span class="linenos">1221</span>                    <span class="p">)</span>
<span class="linenos">1222</span>
<span class="linenos">1223</span>                    <span class="n">new_objs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">1224</span>                    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
<span class="linenos">1225</span>                        <span class="n">fk_val</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">1226</span>                            <span class="bp">self</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">get_foreign_related_value</span><span class="p">(</span><span class="n">obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">1227</span>                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
<span class="linenos">1228</span>                            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">get_prep_value</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="linenos">1229</span>                        <span class="p">)</span>
<span class="linenos">1230</span>                        <span class="k">if</span> <span class="n">fk_val</span> <span class="ow">in</span> <span class="n">old_ids</span><span class="p">:</span>
<span class="linenos">1231</span>                            <span class="n">old_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fk_val</span><span class="p">)</span>
<span class="linenos">1232</span>                        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1233</span>                            <span class="n">new_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="linenos">1234</span>
<span class="linenos">1235</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="o">*</span><span class="n">old_ids</span><span class="p">)</span>
<span class="linenos">1236</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">new_objs</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">)</span>
<span class="linenos">1237</span>
<span class="linenos">1238</span>        <span class="nb">set</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1239</span>
<span class="linenos">1240</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">aset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objs</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">1241</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">)(</span>
<span class="linenos">1242</span>                <span class="n">objs</span><span class="o">=</span><span class="n">objs</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="n">clear</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span>
<span class="linenos">1243</span>            <span class="p">)</span>
<span class="linenos">1244</span>
<span class="linenos">1245</span>        <span class="n">aset</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1246</span>
<span class="linenos">1247</span>        <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">1248</span>            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos">1249</span>            <span class="n">new_obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ManyRelatedManager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">db</span><span class="p">))</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1250</span>            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">)</span>
<span class="linenos">1251</span>            <span class="k">return</span> <span class="n">new_obj</span>
<span class="linenos">1252</span>
<span class="linenos">1253</span>        <span class="n">create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1254</span>
<span class="linenos">1255</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">acreate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">1256</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">)(</span>
<span class="linenos">1257</span>                <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="linenos">1258</span>            <span class="p">)</span>
<span class="linenos">1259</span>
<span class="linenos">1260</span>        <span class="n">acreate</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1261</span>
<span class="linenos">1262</span>        <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">1263</span>            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos">1264</span>            <span class="n">obj</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ManyRelatedManager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">db</span><span class="p">))</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
<span class="linenos">1265</span>                <span class="o">**</span><span class="n">kwargs</span>
<span class="linenos">1266</span>            <span class="p">)</span>
<span class="linenos">1267</span>            <span class="c1"># We only need to add() if created because if we got an object back</span>
<span class="linenos">1268</span>            <span class="c1"># from get() then the relationship already exists.</span>
<span class="linenos">1269</span>            <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
<span class="linenos">1270</span>                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">)</span>
<span class="linenos">1271</span>            <span class="k">return</span> <span class="n">obj</span><span class="p">,</span> <span class="n">created</span>
<span class="linenos">1272</span>
<span class="linenos">1273</span>        <span class="n">get_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1274</span>
<span class="linenos">1275</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">aget_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">1276</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">)(</span>
<span class="linenos">1277</span>                <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="linenos">1278</span>            <span class="p">)</span>
<span class="linenos">1279</span>
<span class="linenos">1280</span>        <span class="n">aget_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1281</span>
<span class="linenos">1282</span>        <span class="k">def</span> <span class="nf">update_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">1283</span>            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos">1284</span>            <span class="n">obj</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span>
<span class="linenos">1285</span>                <span class="n">ManyRelatedManager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="linenos">1286</span>            <span class="p">)</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">1287</span>            <span class="c1"># We only need to add() if created because if we got an object back</span>
<span class="linenos">1288</span>            <span class="c1"># from get() then the relationship already exists.</span>
<span class="linenos">1289</span>            <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
<span class="linenos">1290</span>                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">)</span>
<span class="linenos">1291</span>            <span class="k">return</span> <span class="n">obj</span><span class="p">,</span> <span class="n">created</span>
<span class="linenos">1292</span>
<span class="linenos">1293</span>        <span class="n">update_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1294</span>
<span class="linenos">1295</span>        <span class="k">async</span> <span class="k">def</span> <span class="nf">aupdate_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">1296</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">)(</span>
<span class="linenos">1297</span>                <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="linenos">1298</span>            <span class="p">)</span>
<span class="linenos">1299</span>
<span class="linenos">1300</span>        <span class="n">aupdate_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1301</span>
<span class="linenos">1302</span>        <span class="k">def</span> <span class="nf">_get_target_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_field_name</span><span class="p">,</span> <span class="n">objs</span><span class="p">):</span>
<span class="linenos">1303</span><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1304</span><span class="sd">            Return the set of ids of `objs` that the target field references.</span>
<span class="linenos">1305</span><span class="sd">            &quot;&quot;&quot;</span>
<span class="linenos">1306</span>            <span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="linenos">1307</span>
<span class="linenos">1308</span>            <span class="n">target_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="linenos">1309</span>            <span class="n">target_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">target_field_name</span><span class="p">)</span>
<span class="linenos">1310</span>            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
<span class="linenos">1311</span>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">):</span>
<span class="linenos">1312</span>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">router</span><span class="o">.</span><span class="n">allow_relation</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">):</span>
<span class="linenos">1313</span>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">1314</span>                            <span class="s1">&#39;Cannot add &quot;</span><span class="si">%r</span><span class="s1">&quot;: instance is on database &quot;</span><span class="si">%s</span><span class="s1">&quot;, &#39;</span>
<span class="linenos">1315</span>                            <span class="s1">&#39;value is on database &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span>
<span class="linenos">1316</span>                            <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
<span class="linenos">1317</span>                        <span class="p">)</span>
<span class="linenos">1318</span>                    <span class="n">target_id</span> <span class="o">=</span> <span class="n">target_field</span><span class="o">.</span><span class="n">get_foreign_related_value</span><span class="p">(</span><span class="n">obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">1319</span>                    <span class="k">if</span> <span class="n">target_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1320</span>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="linenos">1321</span>                            <span class="s1">&#39;Cannot add &quot;</span><span class="si">%r</span><span class="s1">&quot;: the value for field &quot;</span><span class="si">%s</span><span class="s1">&quot; is None&#39;</span>
<span class="linenos">1322</span>                            <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">target_field_name</span><span class="p">)</span>
<span class="linenos">1323</span>                        <span class="p">)</span>
<span class="linenos">1324</span>                    <span class="n">target_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">target_id</span><span class="p">)</span>
<span class="linenos">1325</span>                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
<span class="linenos">1326</span>                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
<span class="linenos">1327</span>                        <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; instance expected, got </span><span class="si">%r</span><span class="s2">&quot;</span>
<span class="linenos">1328</span>                        <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
<span class="linenos">1329</span>                    <span class="p">)</span>
<span class="linenos">1330</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">1331</span>                    <span class="n">target_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">target_field</span><span class="o">.</span><span class="n">get_prep_value</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
<span class="linenos">1332</span>            <span class="k">return</span> <span class="n">target_ids</span>
<span class="linenos">1333</span>
<span class="linenos">1334</span>        <span class="k">def</span> <span class="nf">_get_missing_target_ids</span><span class="p">(</span>
<span class="linenos">1335</span>            <span class="bp">self</span><span class="p">,</span> <span class="n">source_field_name</span><span class="p">,</span> <span class="n">target_field_name</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">target_ids</span>
<span class="linenos">1336</span>        <span class="p">):</span>
<span class="linenos">1337</span><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1338</span><span class="sd">            Return the subset of ids of `objs` that aren&#39;t already assigned to</span>
<span class="linenos">1339</span><span class="sd">            this relationship.</span>
<span class="linenos">1340</span><span class="sd">            &quot;&quot;&quot;</span>
<span class="linenos">1341</span>            <span class="n">vals</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">1342</span>                <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="linenos">1343</span>                <span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="n">target_field_name</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">1344</span>                <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<span class="linenos">1345</span>                    <span class="o">**</span><span class="p">{</span>
<span class="linenos">1346</span>                        <span class="n">source_field_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="linenos">1347</span>                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">__in&quot;</span> <span class="o">%</span> <span class="n">target_field_name</span><span class="p">:</span> <span class="n">target_ids</span><span class="p">,</span>
<span class="linenos">1348</span>                    <span class="p">}</span>
<span class="linenos">1349</span>                <span class="p">)</span>
<span class="linenos">1350</span>            <span class="p">)</span>
<span class="linenos">1351</span>            <span class="k">return</span> <span class="n">target_ids</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
<span class="linenos">1352</span>
<span class="linenos">1353</span>        <span class="k">def</span> <span class="nf">_get_add_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">source_field_name</span><span class="p">):</span>
<span class="linenos">1354</span><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1355</span><span class="sd">            Return a boolean triple of the way the add should be performed.</span>
<span class="linenos">1356</span>
<span class="linenos">1357</span><span class="sd">            The first element is whether or not bulk_create(ignore_conflicts)</span>
<span class="linenos">1358</span><span class="sd">            can be used, the second whether or not signals must be sent, and</span>
<span class="linenos">1359</span><span class="sd">            the third element is whether or not the immediate bulk insertion</span>
<span class="linenos">1360</span><span class="sd">            with conflicts ignored can be performed.</span>
<span class="linenos">1361</span><span class="sd">            &quot;&quot;&quot;</span>
<span class="linenos">1362</span>            <span class="c1"># Conflicts can be ignored when the intermediary model is</span>
<span class="linenos">1363</span>            <span class="c1"># auto-created as the only possible collision is on the</span>
<span class="linenos">1364</span>            <span class="c1"># (source_id, target_id) tuple. The same assertion doesn&#39;t hold for</span>
<span class="linenos">1365</span>            <span class="c1"># user-defined intermediary models as they could have other fields</span>
<span class="linenos">1366</span>            <span class="c1"># causing conflicts which must be surfaced.</span>
<span class="linenos">1367</span>            <span class="n">can_ignore_conflicts</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">1368</span>                <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_created</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span>
<span class="linenos">1369</span>                <span class="ow">and</span> <span class="n">connections</span><span class="p">[</span><span class="n">db</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">supports_ignore_conflicts</span>
<span class="linenos">1370</span>            <span class="p">)</span>
<span class="linenos">1371</span>            <span class="c1"># Don&#39;t send the signal when inserting duplicate data row</span>
<span class="linenos">1372</span>            <span class="c1"># for symmetrical reverse entries.</span>
<span class="linenos">1373</span>            <span class="n">must_send_signals</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">1374</span>                <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span> <span class="ow">or</span> <span class="n">source_field_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span>
<span class="linenos">1375</span>            <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">m2m_changed</span><span class="o">.</span><span class="n">has_listeners</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">))</span>
<span class="linenos">1376</span>            <span class="c1"># Fast addition through bulk insertion can only be performed</span>
<span class="linenos">1377</span>            <span class="c1"># if no m2m_changed listeners are connected for self.through</span>
<span class="linenos">1378</span>            <span class="c1"># as they require the added set of ids to be provided via</span>
<span class="linenos">1379</span>            <span class="c1"># pk_set.</span>
<span class="linenos">1380</span>            <span class="k">return</span> <span class="p">(</span>
<span class="linenos">1381</span>                <span class="n">can_ignore_conflicts</span><span class="p">,</span>
<span class="linenos">1382</span>                <span class="n">must_send_signals</span><span class="p">,</span>
<span class="linenos">1383</span>                <span class="p">(</span><span class="n">can_ignore_conflicts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">must_send_signals</span><span class="p">),</span>
<span class="linenos">1384</span>            <span class="p">)</span>
<span class="linenos">1385</span>
<span class="linenos">1386</span>        <span class="k">def</span> <span class="nf">_add_items</span><span class="p">(</span>
<span class="linenos">1387</span>            <span class="bp">self</span><span class="p">,</span> <span class="n">source_field_name</span><span class="p">,</span> <span class="n">target_field_name</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span>
<span class="linenos">1388</span>        <span class="p">):</span>
<span class="linenos">1389</span>            <span class="c1"># source_field_name: the PK fieldname in join table for the source object</span>
<span class="linenos">1390</span>            <span class="c1"># target_field_name: the PK fieldname in join table for the target object</span>
<span class="linenos">1391</span>            <span class="c1"># *objs - objects to add. Either object instances, or primary keys</span>
<span class="linenos">1392</span>            <span class="c1"># of object instances.</span>
<span class="linenos">1393</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">objs</span><span class="p">:</span>
<span class="linenos">1394</span>                <span class="k">return</span>
<span class="linenos">1395</span>
<span class="linenos">1396</span>            <span class="n">through_defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">resolve_callables</span><span class="p">(</span><span class="n">through_defaults</span> <span class="ow">or</span> <span class="p">{}))</span>
<span class="linenos">1397</span>            <span class="n">target_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_target_ids</span><span class="p">(</span><span class="n">target_field_name</span><span class="p">,</span> <span class="n">objs</span><span class="p">)</span>
<span class="linenos">1398</span>            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos">1399</span>            <span class="n">can_ignore_conflicts</span><span class="p">,</span> <span class="n">must_send_signals</span><span class="p">,</span> <span class="n">can_fast_add</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_add_plan</span><span class="p">(</span>
<span class="linenos">1400</span>                <span class="n">db</span><span class="p">,</span> <span class="n">source_field_name</span>
<span class="linenos">1401</span>            <span class="p">)</span>
<span class="linenos">1402</span>            <span class="k">if</span> <span class="n">can_fast_add</span><span class="p">:</span>
<span class="linenos">1403</span>                <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span>
<span class="linenos">1404</span>                    <span class="p">[</span>
<span class="linenos">1405</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">(</span>
<span class="linenos">1406</span>                            <span class="o">**</span><span class="p">{</span>
<span class="linenos">1407</span>                                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_id&quot;</span> <span class="o">%</span> <span class="n">source_field_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="linenos">1408</span>                                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_id&quot;</span> <span class="o">%</span> <span class="n">target_field_name</span><span class="p">:</span> <span class="n">target_id</span><span class="p">,</span>
<span class="linenos">1409</span>                            <span class="p">}</span>
<span class="linenos">1410</span>                        <span class="p">)</span>
<span class="linenos">1411</span>                        <span class="k">for</span> <span class="n">target_id</span> <span class="ow">in</span> <span class="n">target_ids</span>
<span class="linenos">1412</span>                    <span class="p">],</span>
<span class="linenos">1413</span>                    <span class="n">ignore_conflicts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">1414</span>                <span class="p">)</span>
<span class="linenos">1415</span>                <span class="k">return</span>
<span class="linenos">1416</span>
<span class="linenos">1417</span>            <span class="n">missing_target_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_missing_target_ids</span><span class="p">(</span>
<span class="linenos">1418</span>                <span class="n">source_field_name</span><span class="p">,</span> <span class="n">target_field_name</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">target_ids</span>
<span class="linenos">1419</span>            <span class="p">)</span>
<span class="linenos">1420</span>            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">1421</span>                <span class="k">if</span> <span class="n">must_send_signals</span><span class="p">:</span>
<span class="linenos">1422</span>                    <span class="n">signals</span><span class="o">.</span><span class="n">m2m_changed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
<span class="linenos">1423</span>                        <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span>
<span class="linenos">1424</span>                        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;pre_add&quot;</span><span class="p">,</span>
<span class="linenos">1425</span>                        <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
<span class="linenos">1426</span>                        <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span>
<span class="linenos">1427</span>                        <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
<span class="linenos">1428</span>                        <span class="n">pk_set</span><span class="o">=</span><span class="n">missing_target_ids</span><span class="p">,</span>
<span class="linenos">1429</span>                        <span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
<span class="linenos">1430</span>                    <span class="p">)</span>
<span class="linenos">1431</span>                <span class="c1"># Add the ones that aren&#39;t there already.</span>
<span class="linenos">1432</span>                <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span>
<span class="linenos">1433</span>                    <span class="p">[</span>
<span class="linenos">1434</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">(</span>
<span class="linenos">1435</span>                            <span class="o">**</span><span class="n">through_defaults</span><span class="p">,</span>
<span class="linenos">1436</span>                            <span class="o">**</span><span class="p">{</span>
<span class="linenos">1437</span>                                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_id&quot;</span> <span class="o">%</span> <span class="n">source_field_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="linenos">1438</span>                                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_id&quot;</span> <span class="o">%</span> <span class="n">target_field_name</span><span class="p">:</span> <span class="n">target_id</span><span class="p">,</span>
<span class="linenos">1439</span>                            <span class="p">},</span>
<span class="linenos">1440</span>                        <span class="p">)</span>
<span class="linenos">1441</span>                        <span class="k">for</span> <span class="n">target_id</span> <span class="ow">in</span> <span class="n">missing_target_ids</span>
<span class="linenos">1442</span>                    <span class="p">],</span>
<span class="linenos">1443</span>                    <span class="n">ignore_conflicts</span><span class="o">=</span><span class="n">can_ignore_conflicts</span><span class="p">,</span>
<span class="linenos">1444</span>                <span class="p">)</span>
<span class="linenos">1445</span>
<span class="linenos">1446</span>                <span class="k">if</span> <span class="n">must_send_signals</span><span class="p">:</span>
<span class="linenos">1447</span>                    <span class="n">signals</span><span class="o">.</span><span class="n">m2m_changed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
<span class="linenos">1448</span>                        <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span>
<span class="linenos">1449</span>                        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;post_add&quot;</span><span class="p">,</span>
<span class="linenos">1450</span>                        <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
<span class="linenos">1451</span>                        <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span>
<span class="linenos">1452</span>                        <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
<span class="linenos">1453</span>                        <span class="n">pk_set</span><span class="o">=</span><span class="n">missing_target_ids</span><span class="p">,</span>
<span class="linenos">1454</span>                        <span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
<span class="linenos">1455</span>                    <span class="p">)</span>
<span class="linenos">1456</span>
<span class="linenos">1457</span>        <span class="k">def</span> <span class="nf">_remove_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_field_name</span><span class="p">,</span> <span class="n">target_field_name</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">):</span>
<span class="linenos">1458</span>            <span class="c1"># source_field_name: the PK colname in join table for the source object</span>
<span class="linenos">1459</span>            <span class="c1"># target_field_name: the PK colname in join table for the target object</span>
<span class="linenos">1460</span>            <span class="c1"># *objs - objects to remove. Either object instances, or primary</span>
<span class="linenos">1461</span>            <span class="c1"># keys of object instances.</span>
<span class="linenos">1462</span>            <span class="k">if</span> <span class="ow">not</span> <span class="n">objs</span><span class="p">:</span>
<span class="linenos">1463</span>                <span class="k">return</span>
<span class="linenos">1464</span>
<span class="linenos">1465</span>            <span class="c1"># Check that all the objects are of the right type</span>
<span class="linenos">1466</span>            <span class="n">old_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="linenos">1467</span>            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
<span class="linenos">1468</span>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">):</span>
<span class="linenos">1469</span>                    <span class="n">fk_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">get_foreign_related_value</span><span class="p">(</span><span class="n">obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">1470</span>                    <span class="n">old_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fk_val</span><span class="p">)</span>
<span class="linenos">1471</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">1472</span>                    <span class="n">old_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="linenos">1473</span>
<span class="linenos">1474</span>            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
<span class="linenos">1475</span>            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">1476</span>                <span class="c1"># Send a signal to the other end if need be.</span>
<span class="linenos">1477</span>                <span class="n">signals</span><span class="o">.</span><span class="n">m2m_changed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
<span class="linenos">1478</span>                    <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span>
<span class="linenos">1479</span>                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;pre_remove&quot;</span><span class="p">,</span>
<span class="linenos">1480</span>                    <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
<span class="linenos">1481</span>                    <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span>
<span class="linenos">1482</span>                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
<span class="linenos">1483</span>                    <span class="n">pk_set</span><span class="o">=</span><span class="n">old_ids</span><span class="p">,</span>
<span class="linenos">1484</span>                    <span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
<span class="linenos">1485</span>                <span class="p">)</span>
<span class="linenos">1486</span>                <span class="n">target_model_qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
<span class="linenos">1487</span>                <span class="k">if</span> <span class="n">target_model_qs</span><span class="o">.</span><span class="n">_has_filters</span><span class="p">():</span>
<span class="linenos">1488</span>                    <span class="n">old_vals</span> <span class="o">=</span> <span class="n">target_model_qs</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<span class="linenos">1489</span>                        <span class="o">**</span><span class="p">{</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">__in&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">attname</span><span class="p">:</span> <span class="n">old_ids</span><span class="p">}</span>
<span class="linenos">1490</span>                    <span class="p">)</span>
<span class="linenos">1491</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">1492</span>                    <span class="n">old_vals</span> <span class="o">=</span> <span class="n">old_ids</span>
<span class="linenos">1493</span>                <span class="n">filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_remove_filters</span><span class="p">(</span><span class="n">old_vals</span><span class="p">)</span>
<span class="linenos">1494</span>                <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="linenos">1495</span>
<span class="linenos">1496</span>                <span class="n">signals</span><span class="o">.</span><span class="n">m2m_changed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
<span class="linenos">1497</span>                    <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span>
<span class="linenos">1498</span>                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;post_remove&quot;</span><span class="p">,</span>
<span class="linenos">1499</span>                    <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
<span class="linenos">1500</span>                    <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span>
<span class="linenos">1501</span>                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
<span class="linenos">1502</span>                    <span class="n">pk_set</span><span class="o">=</span><span class="n">old_ids</span><span class="p">,</span>
<span class="linenos">1503</span>                    <span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
<span class="linenos">1504</span>                <span class="p">)</span>
<span class="linenos">1505</span>
<span class="linenos">1506</span>    <span class="k">return</span> <span class="n">ManyRelatedManager</span>
</pre></div>

                </article>
              
              
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2023, LECOMTE Thomas.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Créé en utilisant <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Construit avec le <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">Thème PyData Sphinx</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>